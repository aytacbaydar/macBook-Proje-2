<div class="student-ai-tests-page">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <p>Yükleniyor...</p>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-robot me-2"></i>
        Yapay Zeka Destekli Testler
      </h1>
      <p class="page-description">
        Size özel hazırlanmış testleri çözerek kimya bilginizi geliştirin
      </p>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="success" class="alert alert-success alert-dismissible">
    <i class="bi bi-check-circle me-2"></i>
    {{ success }}
    <button type="button" class="btn-close" (click)="success = null"></button>
  </div>

  <div *ngIf="error" class="alert alert-danger alert-dismissible">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Test List Section -->
  <div *ngIf="currentStep === 1" class="test-list-section">
    <div class="list-header">
      <h3 class="section-title">
        <i class="bi bi-list-ul me-2"></i>
        Testlerim
      </h3>
      <button class="btn" (click)="startNewTest()" [disabled]="loading || loadingTestList">
        <i class="bi bi-plus-circle me-2"></i>
        Yeni Test Oluştur
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loadingTestList" class="text-center p-4">
      <div class="spinner-border text-primary me-2"></div>
      <span>Testler yükleniyor...</span>
    </div>

    <!-- Test List -->
    <div *ngIf="!loadingTestList && testListesi.length > 0" class="test-cards">
      <div *ngFor="let test of testListesi" class="test-card">
        <div class="test-card-header">
          <div class="test-info">
            <h5 class="test-title">
              <i class="bi bi-file-text me-2"></i>
              {{ test.test_adi || 'Test adı bulunamadı' }}
            </h5>
            <p class="test-date">
              <i class="bi bi-calendar me-1"></i>
              {{ formatDate(test.olusturma_tarihi) }}
            </p>
          </div>
          <div class="test-status">
            <span class="badge" [class.bg-success]="test.tamamlandi" [class.bg-warning]="!test.tamamlandi">
              {{ test.tamamlandi ? 'Tamamlandı' : 'Devam Ediyor' }}
            </span>
            <div *ngIf="test.tamamlandi && test.test_sonuclari" class="test-results-summary">
              <span class="result-item success">
                <i class="bi bi-check-circle"></i>
                {{ test.test_sonuclari.dogru_sayisi }}
              </span>
              <span class="result-item danger">
                <i class="bi bi-x-circle"></i>
                {{ test.test_sonuclari.yanlis_sayisi }}
              </span>
              <span class="result-item secondary">
                <i class="bi bi-circle"></i>
                {{ test.test_sonuclari.bos_sayisi }}
              </span>
              <span class="result-item info">
                <strong>%{{ test.test_sonuclari.yuzde }}</strong>
              </span>
            </div>
          </div>
        </div>

        <div class="test-card-body">
          <div class="test-stats">
            <div class="stat-item">
              <i class="bi bi-question-circle"></i>
              <span>{{ test.toplam_soru }} Soru</span>
            </div>
            <div *ngIf="test.tamamlandi" class="stat-item">
              <i class="bi bi-check-circle text-success"></i>
              <span>{{ test.dogru_sayisi }} Doğru</span>
            </div>
            <div *ngIf="test.tamamlandi" class="stat-item">
              <i class="bi bi-percent"></i>
              <span>%{{ test.yuzde?.toFixed(1) }}</span>
            </div>
          </div>
        </div>

        <div class="test-card-actions">
          <button class="btn btn-outline-primary btn-sm me-2" (click)="continueTest(test)" [disabled]="loading">
            <i class="bi" [class.bi-play]="!test.tamamlandi" [class.bi-eye]="test.tamamlandi"></i>
            {{ test.tamamlandi ? 'Sonuçları Gör' : 'Devam Et' }}
          </button>
          <button class="btn btn-outline-secondary btn-sm me-2" (click)="downloadTestPdfById(test.id)" [disabled]="loading">
            <i class="bi bi-file-pdf"></i>
            PDF
          </button>
          <button class="btn btn-outline-danger btn-sm" 
                  (click)="deleteTest(test.id)"
                  [disabled]="loading">
            <i class="bi bi-trash"></i>
            Sil
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loadingTestList && testListesi.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-inbox"></i>
      </div>
      <h4>Henüz Test Oluşturmamışsınız</h4>
      <p>Yapay zeka destekli kişiselleştirilmiş testler oluşturarak kimya bilginizi geliştirin.</p>
      <button class="btn btn-primary" (click)="startNewTest()">
        <i class="bi bi-plus-circle me-2"></i>
        İlk Testinizi Oluşturun
      </button>
    </div>
  </div>

  <!-- Test Creation Section -->
  <div *ngIf="currentStep === 2" class="test-creation-section">
    <div class="creation-card">
      <h3 class="section-title">
        <i class="bi bi-plus-circle me-2"></i>
        Yeni Test Oluştur
      </h3>

      <div class="topic-selection">
        <h4>Geliştirilmesi Gereken Konular</h4>
        <p class="help-text">Bu konulardan kolay sorular sorulacak</p>
        <div class="topics-grid">
          <div class="topic-item" 
               *ngFor="let konu of improvementTopics"
               [class.selected]="isImprovementTopicSelected(konu.konu_adi)"
               (click)="toggleImprovementTopic(konu.konu_adi)">
            <i class="bi bi-arrow-up-circle"></i>
            <span>{{ konu.konu_adi }}</span>
          </div>
        </div>

        <h4 class="mt-4">En İyi Olduğunuz Konular</h4>
        <p class="help-text">Bu konulardan zor sorular sorulacak</p>
        <div class="topics-grid">
          <div class="topic-item"
               *ngFor="let konu of bestTopics"
               [class.selected]="isBestTopicSelected(konu.konu_adi)"
               (click)="toggleBestTopic(konu.konu_adi)">
            <i class="bi bi-star-fill"></i>
            <span>{{ konu.konu_adi }}</span>
          </div>
        </div>

        <h4 class="mt-4">Diğer Konular</h4>
        <p class="help-text">Tüm konulardan istediğiniz konuları seçebilirsiniz</p>

        <div *ngIf="loadingKonular" class="text-center py-3">
          <div class="spinner-border text-primary me-2"></div>
          <span>Konular yükleniyor...</span>
        </div>

        <div *ngIf="!loadingKonular && otherTopics.length > 0" class="topics-grid">
          <div class="topic-item"
               *ngFor="let konu of otherTopics"
               [class.selected]="isOtherTopicSelected(konu.konu_adi)"
               (click)="toggleOtherTopic(konu.konu_adi)">
            <i class="bi bi-book"></i>
            <span>{{ konu.konu_adi }}</span>
          </div>
        </div>

        <div class="question-counts mt-4">
          <h5>Soru Sayıları ve Zorluk Seviyeleri</h5>

          <!-- Zorluk Seviyesi Seçim Yöntemi -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label fw-bold">Zorluk Seviyesi Seçim Yöntemi:</label>
              <div class="form-check-container d-flex gap-3">
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="difficultyMode" 
                         id="mixedMode" [value]="false" [(ngModel)]="singleDifficultyMode">
                  <label class="form-check-label" for="mixedMode">
                    Karışık Zorluk (Kolay + Orta + Zor)
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="difficultyMode" 
                         id="singleMode" [value]="true" [(ngModel)]="singleDifficultyMode">
                  <label class="form-check-label" for="singleMode">
                    Tek Zorluk Seviyesi
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Karışık Zorluk Modu -->
          <div *ngIf="!singleDifficultyMode" class="row">
            <div class="col-md-4">
              <label class="form-label">Kolay Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="kolayQuestionCount" 
                     min="0" max="20">
            </div>
            <div class="col-md-4">
              <label class="form-label">Orta Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="ortaQuestionCount" 
                     min="0" max="20">
            </div>
            <div class="col-md-4">
              <label class="form-label">Zor Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="zorQuestionCount" 
                     min="0" max="20">
            </div>
          </div>

          <!-- Tek Zorluk Modu -->
          <div *ngIf="singleDifficultyMode" class="row">
            <div class="col-md-6">
              <label class="form-label">Zorluk Seviyesi</label>
              <select class="form-select" [(ngModel)]="selectedSingleDifficulty">
                <option value="kolay">Kolay</option>
                <option value="orta">Orta</option>
                <option value="zor">Zor</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Toplam Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="totalQuestionCount" 
                     min="1" max="25">
            </div>
          </div>

          <!-- Toplam Soru Sayısı Göstergesi -->
          <div class="mt-3">
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              <strong>Toplam Soru Sayısı: {{ getTotalQuestionCount() }}</strong>
              <span *ngIf="!singleDifficultyMode"> 
                ({{ kolayQuestionCount }} Kolay + {{ ortaQuestionCount }} Orta + {{ zorQuestionCount }} Zor)
              </span>
              <span *ngIf="singleDifficultyMode">
                ({{ totalQuestionCount }} {{ selectedSingleDifficulty | titlecase }})
              </span>
            </div>
          </div>
        </div>

        <div class="actions mt-4">
          <button class="btn btn-outline-secondary me-2" (click)="backToTestList()" [disabled]="loading">
            <i class="bi bi-arrow-left me-2"></i>
            Geri Dön
          </button>
          <button class="btn btn-primary"
                  [disabled]="loading || (selectedImprovementTopics.length === 0 && selectedBestTopics.length === 0 && selectedOtherTopics.length === 0) || getTotalQuestionCount() < 1"
                  (click)="createTest()">
            <i class="bi bi-magic me-2"></i>
            Test Oluştur
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Taking Section -->
  <div *ngIf="currentTest && !showResults" class="test-taking-section">
    <div class="test-header">
      <div class="test-info">
        <h2>{{ currentTest.test_adi }}</h2>
        <div class="test-meta">
          <span class="test-date">{{ formatDate(currentTest.olusturma_tarihi) }}</span>
          <span class="question-count">{{ currentTest.sorular.length }} Soru</span>
          <span class="time-remaining" *ngIf="remainingTime > 0">
            <i class="bi bi-clock"></i>
            {{ formatTime(remainingTime) }}
          </span>
        </div>
      </div>
      <div class="test-actions">
        <button class="btn btn-outline-secondary" (click)="downloadTestPDF()">
          <i class="bi bi-file-pdf me-2"></i>
          PDF İndir
        </button>
      </div>
    </div>

    <div class="test-content">
      <!-- Sol Taraf - Sorular -->
      <div class="questions-section">
        <div class="question-container" *ngIf="currentTest.sorular[currentQuestionIndex] as currentQuestion">
          <div class="question-card">
            <div class="question-header">
              <div class="question-number">
                <span class="number">{{ currentQuestionIndex + 1 }}</span>
                <span class="total">/ {{ currentTest.sorular.length }}</span>
              </div>
              <div class="question-tags">
                <span class="badge bg-primary">{{ currentQuestion.konu_adi }}</span>
                <span class="badge" [class]="'bg-' + (currentQuestion.zorluk_derecesi === 'kolay' ? 'success' : 
                         currentQuestion.zorluk_derecesi === 'orta' ? 'warning' : 'danger')">
                  {{ currentQuestion.zorluk_derecesi }}
                </span>
              </div>
            </div>

            <div class="question-content">
              <!-- Soru resmi varsa göster -->
              <div *ngIf="currentQuestion.soru_resmi" class="question-image">
                <img [src]="getSoruResmiUrl(currentQuestion)" 
                     alt="Soru Resmi" 
                     class="img-fluid">
              </div>

              <!-- Soru metni varsa göster -->
              <div *ngIf="currentQuestion.soru_aciklamasi" class="question-text">
                {{ currentQuestion.soru_aciklamasi }}
              </div>

              <!-- Seçenekler -->
              <div class="answer-options" *ngIf="currentQuestion.secenekler">
                <div class="option-item" 
                     *ngFor="let option of getOptionsArray(currentQuestion.secenekler); let i = index"
                     [class.selected]="userAnswers[currentQuestionIndex] === getOptionLetter(i)"
                     (click)="selectAnswer(currentQuestionIndex, getOptionLetter(i))"
                     style="cursor: pointer;">
                  <div class="option-letter">{{ getOptionLetter(i) }}</div>
                  <div class="option-content">{{ option }}</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Navigation Controls -->
        <div class="question-navigation">
          <button class="btn btn-outline-secondary" 
                  (click)="previousQuestion()" 
                  [disabled]="currentQuestionIndex === 0">
            <i class="bi bi-arrow-left me-2"></i>
            Önceki
          </button>

          <button class="btn btn-outline-secondary" 
                  (click)="nextQuestion()" 
                  [disabled]="currentQuestionIndex === currentTest.sorular.length - 1">
            Sonraki
            <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </div>
      </div>

      <!-- Sağ Taraf - Optik Form -->
      <div class="optical-form-section">
        <div class="optical-form">
          <div class="optical-header">
            <h4>Cevap Kağıdı</h4>
            <div class="progress-info">
              <span class="answered">{{ getAnsweredQuestionsCount() }}</span>
              <span class="separator">/</span>
              <span class="total">{{ currentTest.sorular.length }}</span>
            </div>
          </div>

          <div class="optical-grid">
            <div class="optical-row" 
                 *ngFor="let soru of currentTest.sorular; let i = index"
                 [class.current]="i === currentQuestionIndex"
                 [class.answered]="userAnswers[i]">
              <div class="question-number">{{ i + 1 }}</div>
              <div class="options">
                <button class="option-btn"
                        *ngFor="let option of ['A', 'B', 'C', 'D', 'E']; let j = index"
                        [class.selected]="userAnswers[i] === option"
                        [class.unavailable]="!hasOption(currentTest.sorular[i], j)"
                        (click)="hasOption(currentTest.sorular[i], j) ? selectAnswer(i, option) : null">
                  {{ option }}
                </button>
              </div>
              <button class="clear-btn" 
                      *ngIf="userAnswers[i]"
                      (click)="clearAnswer(i)"
                      title="Cevabı Temizle">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>

          <!-- Test Bitir Butonu -->
          <div class="finish-test-section">
            <div class="completion-status">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="(getAnsweredQuestionsCount() / currentTest.sorular.length) * 100"></div>
              </div>
              <span class="completion-text">
                %{{ Math.round((getAnsweredQuestionsCount() / currentTest.sorular.length) * 100) }} Tamamlandı
              </span>
            </div>

            <button class="btn btn-success btn-finish" 
                    (click)="finishTest()"
                    [disabled]="getAnsweredQuestionsCount() === 0">
              <i class="bi bi-check-circle me-2"></i>
              Testi Bitir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results Section -->
  <div *ngIf="showResults && testResults" class="results-section">
    <div class="results-card">
      <div class="results-header">
        <h3>
          <i class="bi bi-clipboard-data me-2"></i>
          Test Sonuçları
        </h3>
        <div class="results-meta">
          <span class="test-name">{{ currentTest?.test_adi }}</span>
          <span class="completion-date">{{ formatDate(testResults.tamamlanma_tarihi) }}</span>
        </div>
      </div>

      <div class="results-summary">
        <div class="summary-grid">
          <div class="summary-item correct">
            <div class="summary-icon">
              <i class="bi bi-check-circle-fill"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ testResults.dogru_sayisi }}</div>
              <div class="summary-label">Doğru</div>
            </div>
          </div>

          <div class="summary-item incorrect">
            <div class="summary-icon">
              <i class="bi bi-x-circle-fill"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ testResults.yanlis_sayisi }}</div>
              <div class="summary-label">Yanlış</div>
            </div>
          </div>

          <div class="summary-item empty">
            <div class="summary-icon">
              <i class="bi bi-circle"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ testResults.bos_sayisi }}</div>
              <div class="summary-label">Boş</div>
            </div>
          </div>

          <div class="summary-item score">
            <div class="summary-icon">
              <i class="bi bi-trophy-fill"></i>
            </div>
            <div class="summary-content">
              <div class="summary-number">{{ testResults.yuzde }}%</div>
              <div class="summary-label">Başarı</div>
            </div>
          </div>
        </div>
      </div>

      <div class="results-actions">
        <button class="btn btn-primary" (click)="createNewTestFromResults()">
          <i class="bi bi-arrow-repeat me-2"></i>
          Yeni Test Oluştur
        </button>
        <button class="btn btn-outline-secondary" (click)="downloadCurrentTestPDF()">
          <i class="bi bi-file-pdf me-2"></i>
          Test PDF
        </button>
        <button class="btn btn-info" (click)="showQuestionDetails = !showQuestionDetails">
          <i class="bi bi-list-check me-2"></i>
          {{ showQuestionDetails ? 'Detayları Gizle' : 'Soru Bazında Sonuçlar' }}
        </button>
      </div>

      <!-- Soru Bazında Detaylar -->
      <div *ngIf="showQuestionDetails" class="question-details">
        <h4>Soru Bazında Sonuçlar</h4>
        <div class="details-grid">
          <div class="detail-item" 
               *ngFor="let detail of testResults.details; let i = index"
               [class]="getQuestionResultClass(detail)">
            <div class="detail-header">
              <span class="question-number">{{ i + 1 }}</span>
              <span class="result-icon">
                <i class="bi" [class]="getQuestionResultIcon(detail)"></i>
              </span>
            </div>
            <div class="detail-content">
              <div class="answer-info">
                <span class="correct-answer">Doğru: {{ detail.dogru_cevap }}</span>
                <span class="user-answer" *ngIf="detail.user_answer">
                  Cevabınız: {{ detail.user_answer }}
                </span>
                <span class="no-answer" *ngIf="!detail.user_answer">
                  Cevaplamadınız
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modern Confirm Dialog -->
<app-confirm-dialog
  [isVisible]="showConfirmDialog"
  [title]="confirmDialogData.title"
  [message]="confirmDialogData.message"
  [confirmText]="confirmDialogData.confirmText"
  [cancelText]="confirmDialogData.cancelText"
  [type]="confirmDialogData.type"
  (confirmed)="onConfirmDialogConfirmed()"
  (cancelled)="onConfirmDialogCancelled()">
</app-confirm-dialog>