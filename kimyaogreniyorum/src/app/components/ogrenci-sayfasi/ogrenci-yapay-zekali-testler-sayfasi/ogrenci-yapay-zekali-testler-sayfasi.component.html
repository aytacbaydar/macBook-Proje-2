<div class="student-ai-tests-page">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <p>Yükleniyor...</p>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="bi bi-robot me-2"></i>
        Yapay Zeka Destekli Testler
      </h1>
      <p class="page-description">
        Size özel hazırlanmış testleri çözerek kimya bilginizi geliştirin
      </p>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="success" class="alert alert-success alert-dismissible">
    <i class="bi bi-check-circle me-2"></i>
    {{ success }}
    <button type="button" class="btn-close" (click)="success = null"></button>
  </div>

  <div *ngIf="error" class="alert alert-danger alert-dismissible">
    <i class="bi bi-exclamation-triangle me-2"></i>
    {{ error }}
    <button type="button" class="btn-close" (click)="error = null"></button>
  </div>

  <!-- Test List Section -->
  <div *ngIf="currentStep === 1" class="test-list-section">
    <div class="list-header">
      <h3 class="section-title">
        <i class="bi bi-list-ul me-2"></i>
        Testlerim
      </h3>
      <button class="btn btn-primary" (click)="startNewTest()" [disabled]="loading">
        <i class="bi bi-plus-circle me-2"></i>
        Yeni Test Oluştur
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loadingTestList" class="text-center p-4">
      <div class="spinner-border text-primary me-2"></div>
      <span>Testler yükleniyor...</span>
    </div>

    <!-- Test List -->
    <div *ngIf="!loadingTestList && testListesi.length > 0" class="test-cards">
      <div *ngFor="let test of testListesi" class="test-card">
        <div class="test-card-header">
          <div class="test-info">
            <h5 class="test-title">
              <i class="bi bi-file-text me-2"></i>
              Test #{{ test.id }}
            </h5>
            <p class="test-date">
              <i class="bi bi-calendar me-1"></i>
              {{ formatDate(test.olusturma_tarihi) }}
            </p>
          </div>
          <div class="test-status">
            <span class="badge" [class.bg-success]="test.tamamlandi" [class.bg-warning]="!test.tamamlandi">
              {{ test.tamamlandi ? 'Tamamlandı' : 'Devam Ediyor' }}
            </span>
          </div>
        </div>

        <div class="test-card-body">
          <div class="test-stats">
            <div class="stat-item">
              <i class="bi bi-question-circle"></i>
              <span>{{ test.toplam_soru }} Soru</span>
            </div>
            <div *ngIf="test.tamamlandi" class="stat-item">
              <i class="bi bi-check-circle text-success"></i>
              <span>{{ test.dogru_sayisi }} Doğru</span>
            </div>
            <div *ngIf="test.tamamlandi" class="stat-item">
              <i class="bi bi-percent"></i>
              <span>%{{ test.yuzde?.toFixed(1) }}</span>
            </div>
          </div>
        </div>

        <div class="test-card-actions">
          <button class="btn btn-outline-primary btn-sm me-2" (click)="continueTest(test)" [disabled]="loading">
            <i class="bi" [class.bi-play]="!test.tamamlandi" [class.bi-eye]="test.tamamlandi"></i>
            {{ test.tamamlandi ? 'Sonuçları Gör' : 'Devam Et' }}
          </button>
          <button class="btn btn-outline-secondary btn-sm" (click)="downloadTestPdfById(test.id)" [disabled]="loading">
            <i class="bi bi-file-pdf"></i>
            PDF
          </button>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loadingTestList && testListesi.length === 0" class="empty-state">
      <div class="empty-icon">
        <i class="bi bi-inbox"></i>
      </div>
      <h4>Henüz Test Oluşturmamışsınız</h4>
      <p>Yapay zeka destekli kişiselleştirilmiş testler oluşturarak kimya bilginizi geliştirin.</p>
      <button class="btn btn-primary" (click)="startNewTest()">
        <i class="bi bi-plus-circle me-2"></i>
        İlk Testinizi Oluşturun
      </button>
    </div>
  </div>

  <!-- Test Creation Section -->
  <div *ngIf="currentStep === 2" class="test-creation-section">
    <div class="creation-card">
      <h3 class="section-title">
        <i class="bi bi-plus-circle me-2"></i>
        Yeni Test Oluştur
      </h3>

      <div class="topic-selection">
        <h4>Geliştirilmesi Gereken Konular</h4>
        <p class="help-text">Bu konulardan kolay sorular sorulacak</p>
        <div class="topics-grid">
          <div class="topic-item" 
               *ngFor="let konu of improvementTopics"
               [class.selected]="isImprovementTopicSelected(konu.konu_adi)"
               (click)="toggleImprovementTopic(konu.konu_adi)">
            <i class="bi bi-arrow-up-circle"></i>
            <span>{{ konu.konu_adi }}</span>
          </div>
        </div>

        <h4 class="mt-4">En İyi Olduğunuz Konular</h4>
        <p class="help-text">Bu konulardan zor sorular sorulacak</p>
        <div class="topics-grid">
          <div class="topic-item"
               *ngFor="let konu of bestTopics"
               [class.selected]="isBestTopicSelected(konu.konu_adi)"
               (click)="toggleBestTopic(konu.konu_adi)">
            <i class="bi bi-star-fill"></i>
            <span>{{ konu.konu_adi }}</span>
          </div>
        </div>

        <div class="question-counts mt-4">
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">Kolay Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="improvementQuestionCount" 
                     min="1" max="20">
            </div>
            <div class="col-md-6">
              <label class="form-label">Zor Soru Sayısı</label>
              <input type="number" class="form-control" 
                     [(ngModel)]="challengeQuestionCount" 
                     min="1" max="20">
            </div>
          </div>
        </div>

        <div class="actions mt-4">
          <button class="btn btn-outline-secondary me-2" (click)="backToTestList()" [disabled]="loading">
            <i class="bi bi-arrow-left me-2"></i>
            Geri Dön
          </button>
          <button class="btn btn-primary" 
                  (click)="createTest()" 
                  [disabled]="loading || (selectedImprovementTopics.length === 0 && selectedBestTopics.length === 0)">
            <i class="bi bi-magic me-2"></i>
            Test Oluştur
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Questions Section -->
  <div *ngIf="currentStep === 4 && currentTest && !showResults" class="test-section">
    <div class="test-header">
      <div class="test-info">
        <h3>Yapay Zeka Testi</h3>
        <div class="test-stats">
          <span class="badge bg-info me-2">
            Soru {{ currentQuestionIndex + 1 }}/{{ currentTest.sorular.length }}
          </span>
          <span class="badge bg-secondary">
            {{ getAnsweredQuestionsCount() }} Cevaplandı
          </span>
        </div>
      </div>
      <div class="test-actions">
        <button class="btn btn-outline-primary" (click)="downloadTestPDF()" [disabled]="loading">
          <i class="bi bi-file-pdf me-2"></i>
          PDF İndir
        </button>
      </div>
    </div>

    <div class="question-container" *ngIf="currentTest.sorular[currentQuestionIndex] as currentQuestion">
      <div class="question-card">
        <div class="question-header">
          <div class="question-info">
            <span class="badge bg-primary me-2">{{ currentQuestion.konu_adi }}</span>
            <span class="badge" [class]="'bg-' + (currentQuestion.zorluk_derecesi === 'kolay' ? 'success' : 
                     currentQuestion.zorluk_derecesi === 'orta' ? 'warning' : 'danger')">
              {{ currentQuestion.zorluk_derecesi }}
            </span>
          </div>
        </div>

        <div class="question-content">
          <div class="question-text mb-3">
            <h5>{{ currentQuestion.soru_metni }}</h5>
          </div>

          <!-- Soru resmi varsa göster -->
          <div *ngIf="currentQuestion.soru_resmi" class="question-image mb-3">
            <img [src]="getSoruResmiUrl(currentQuestion)" 
                 alt="Soru Resmi" 
                 class="img-fluid"
                 style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          </div>

          <div class="question-description mb-3" *ngIf="currentQuestion.aciklama">
            <p>{{ currentQuestion.aciklama }}</p>
          </div>

          <!-- Seçenekler -->
          <div class="answer-options">
            <div class="option-item" 
                 *ngIf="currentQuestion.secenekler.A"
                 [class.selected]="userAnswers[currentQuestionIndex] === 'A'"
                 (click)="selectAnswer(currentQuestionIndex, 'A')">
              <div class="option-circle">A</div>
              <div class="option-text">{{ currentQuestion.secenekler.A }}</div>
            </div>
            <div class="option-item" 
                 *ngIf="currentQuestion.secenekler.B"
                 [class.selected]="userAnswers[currentQuestionIndex] === 'B'"
                 (click)="selectAnswer(currentQuestionIndex, 'B')">
              <div class="option-circle">B</div>
              <div class="option-text">{{ currentQuestion.secenekler.B }}</div>
            </div>
            <div class="option-item" 
                 *ngIf="currentQuestion.secenekler.C"
                 [class.selected]="userAnswers[currentQuestionIndex] === 'C'"
                 (click)="selectAnswer(currentQuestionIndex, 'C')">
              <div class="option-circle">C</div>
              <div class="option-text">{{ currentQuestion.secenekler.C }}</div>
            </div>
            <div class="option-item" 
                 *ngIf="currentQuestion.secenekler.D"
                 [class.selected]="userAnswers[currentQuestionIndex] === 'D'"
                 (click)="selectAnswer(currentQuestionIndex, 'D')">
              <div class="option-circle">D</div>
              <div class="option-text">{{ currentQuestion.secenekler.D }}</div>
            </div>
            <div class="option-item" 
                 *ngIf="currentQuestion.secenekler.E"
                 [class.selected]="userAnswers[currentQuestionIndex] === 'E'"
                 (click)="selectAnswer(currentQuestionIndex, 'E')">
              <div class="option-circle">E</div>
              <div class="option-text">{{ currentQuestion.secenekler.E }}</div>
            </div>
          </div>
        </div>

        <div class="question-navigation mt-4">
          <button class="btn btn-outline-secondary" 
                  (click)="previousQuestion()" 
                  [disabled]="currentQuestionIndex === 0">
            <i class="bi bi-arrow-left me-2"></i>
            Önceki
          </button>

          <div class="question-dots mx-3">
            <span class="dot me-1" 
                  *ngFor="let soru of currentTest.sorular; let i = index"
                  [class.current]="i === currentQuestionIndex"
                  [class.answered]="userAnswers[i]"
                  (click)="goToQuestion(i)">
              {{ i + 1 }}
            </span>
          </div>

          <button class="btn btn-outline-secondary" 
                  (click)="nextQuestion()" 
                  [disabled]="currentQuestionIndex === currentTest.sorular.length - 1">
            Sonraki
            <i class="bi bi-arrow-right ms-2"></i>
          </button>

          <!-- Testi Bitir butonu - her zaman görünür -->
          <button class="btn btn-success ms-3" 
                  (click)="finishTest()"
                  [disabled]="getAnsweredQuestionsCount() === 0">
            <i class="bi bi-check-circle me-2"></i>
            Testi Bitir ({{ getAnsweredQuestionsCount() }}/{{ currentTest.sorular.length }})
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results Section -->
  <div *ngIf="showResults && testResults" class="results-section">
    <div class="results-card">
      <div class="results-header">
        <h3>
          <i class="bi bi-trophy me-2"></i>
          Test Sonuçları
        </h3>
        <div class="score-badge">
          <span class="score">{{ testResults.dogru_sayisi }}/{{ testResults.toplam_soru }}</span>
          <span class="percentage">%{{ testResults.yuzde.toFixed(1) }}</span>
        </div>
      </div>

      <div class="results-stats">
        <div class="stat-item success">
          <i class="bi bi-check-circle"></i>
          <div>
            <span class="count">{{ testResults.dogru_sayisi }}</span>
            <span class="label">Doğru</span>
          </div>
        </div>
        <div class="stat-item danger">
          <i class="bi bi-x-circle"></i>
          <div>
            <span class="count">{{ testResults.yanlis_sayisi }}</span>
            <span class="label">Yanlış</span>
          </div>
        </div>
        <div class="stat-item secondary">
          <i class="bi bi-circle"></i>
          <div>
            <span class="count">{{ testResults.bos_sayisi }}</span>
            <span class="label">Boş</span>
          </div>
        </div>
        <div class="stat-item info">
          <i class="bi bi-calculator"></i>
          <div>
            <span class="count">{{ testResults.net.toFixed(2) }}</span>
            <span class="label">Net</span>
          </div>
        </div>
      </div>

      <div class="results-actions">
        <button class="btn btn-primary" (click)="resetTest()">
          <i class="bi bi-arrow-repeat me-2"></i>
          Yeni Test Oluştur
        </button>
        <button class="btn btn-outline-secondary" (click)="downloadTestPDF()">
          <i class="bi bi-file-pdf me-2"></i>
          Test PDF
        </button>
      </div>
    </div>
  </div>
</div>