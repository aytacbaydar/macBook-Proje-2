
<div class="modern-payment-page">
  <!-- Header Section -->
  <div class="payment-header">
    <div class="header-content">
      <div class="header-icon">
        <i class="bi bi-credit-card-2-front"></i>
      </div>
      <div class="header-text">
        <h1 class="page-title">Ücret ve Ödeme Bilgilerim</h1>
        <p class="page-subtitle" *ngIf="currentStudent">{{ currentStudent.adi_soyadi }}</p>
      </div>
      <button class="pdf-export-btn" (click)="pdfKaydet()" [disabled]="isLoading">
        <i class="bi bi-file-earmark-pdf"></i>
        <span>PDF İndir</span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Bilgileriniz yükleniyor...</p>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="!isLoading && currentStudent" class="payment-content">
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card attendance-card">
        <div class="stat-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalPresentCount() }}</div>
          <div class="stat-label">Katıldığım Ders</div>
          <div class="stat-description">Toplam katılım sayısı</div>
        </div>
      </div>

      <div class="stat-card debt-card">
        <div class="stat-icon">
          <i class="bi bi-calculator"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ formatCurrency(getTotalDebtAmount()) }}</div>
          <div class="stat-label">Toplam Borç</div>
          <div class="stat-description" *ngIf="studentStats">
            {{ studentStats.attendance_stats.present_count }} ders × {{ formatCurrency(studentStats.student_info.ucret / 4) }}
          </div>
        </div>
      </div>

      <div class="stat-card payment-card">
        <div class="stat-icon">
          <i class="bi bi-check-circle"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ formatCurrency(getTotalPaidAmount()) }}</div>
          <div class="stat-label">Toplam Ödenen</div>
          <div class="stat-description">{{ paymentHistory.length }} ödeme yapıldı</div>
        </div>
      </div>

      <div class="stat-card balance-card" [class.positive]="getRemainingDebt() <= 0" [class.negative]="getRemainingDebt() > 0">
        <div class="stat-icon">
          <i class="bi bi-exclamation-triangle" *ngIf="getRemainingDebt() > 0"></i>
          <i class="bi bi-check-circle-fill" *ngIf="getRemainingDebt() <= 0"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ formatCurrency(Math.abs(getRemainingDebt())) }}</div>
          <div class="stat-label">{{ getRemainingDebt() > 0 ? 'Kalan Borç' : 'Fazla Ödeme' }}</div>
          <div class="stat-description">
            {{ getRemainingDebt() > 0 ? 'Ödeme yapılması gerekiyor' : 'Borç bulunmuyor' }}
          </div>
        </div>
      </div>
    </div>

    <!-- Payment History Section -->
    <div class="payment-history-section" *ngIf="paymentHistory && paymentHistory.length > 0">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-receipt"></i>
          Ödeme Geçmişim
        </h2>
        <div class="section-summary">
          <span class="total-payments">{{ paymentHistory.length }} ödeme</span>
          <span class="total-amount">{{ formatCurrency(getTotalPaidAmount()) }}</span>
        </div>
      </div>

      <div class="payment-timeline">
        <div class="payment-item" *ngFor="let payment of paymentHistory; let i = index">
          <div class="payment-marker">
            <span class="payment-number">{{ i + 1 }}</span>
          </div>
          <div class="payment-details">
            <div class="payment-amount">{{ formatCurrency(payment.tutar) }}</div>
            <div class="payment-date">{{ formatDate(payment.odeme_tarihi) }}</div>
            <div class="payment-description" *ngIf="payment.aciklama">{{ payment.aciklama }}</div>
            <div class="payment-period">{{ payment.ay }}/{{ payment.yil }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Attendance History Section -->
    <div class="attendance-history-section" *ngIf="groupedAttendanceByDate.length > 0">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-clock-history"></i>
          Ders Katılım Geçmişim
        </h2>
        <div class="section-filters">
          <button class="filter-btn" (click)="setDateRangeThisMonth()">Bu Ay</button>
          <button class="filter-btn" (click)="setDateRangeThisYear()">Bu Yıl</button>
          <button class="filter-btn" (click)="loadAllAttendanceRecords()">Tümü</button>
        </div>
      </div>

      <div class="attendance-timeline">
        <div class="attendance-item" *ngFor="let kayit of historicalAttendance; let i = index">
          <div class="attendance-date">
            <div class="date-display">
              <span class="day">{{ formatDate(kayit.tarih) }}</span>
              <span class="weekday">{{ getDayName(kayit.tarih) }}</span>
            </div>
          </div>
          <div class="attendance-status" [class.present]="kayit.durum === 'present'" [class.absent]="kayit.durum === 'absent'">
            <div class="status-icon">
              <i class="bi bi-check-circle-fill" *ngIf="kayit.durum === 'present'"></i>
              <i class="bi bi-x-circle-fill" *ngIf="kayit.durum === 'absent'"></i>
            </div>
            <div class="status-text">
              {{ kayit.durum === 'present' ? 'Katıldım' : 'Katılmadım' }}
            </div>
            <div class="lesson-type" *ngIf="kayit.ders_tipi">
              {{ kayit.ders_tipi === 'ek_ders' ? 'Ek Ders' : kayit.ders_tipi === 'etut_dersi' ? 'Etüt' : 'Normal Ders' }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Student Analysis Table -->
    <div class="analysis-section" *ngIf="currentStudent && historicalAttendance.length > 0">
      <div class="section-header">
        <h2 class="section-title">
          <i class="bi bi-graph-up"></i>
          Detaylı Katılım Analizim
        </h2>
      </div>

      <div class="analysis-table-wrapper">
        <div class="table-responsive">
          <table class="analysis-table">
            <thead>
              <tr>
                <th rowspan="2">Öğrenci</th>
                <th rowspan="2">Toplam Kayıt</th>
                <th colspan="4">Katıldığım Dersler</th>
                <th colspan="4">Devamsızlık</th>
                <th rowspan="2">Katılım %</th>
              </tr>
              <tr>
                <th>Toplam</th>
                <th>Normal</th>
                <th>Ek Ders</th>
                <th>Etüt</th>
                <th>Toplam</th>
                <th>Normal</th>
                <th>Ek Ders</th>
                <th>Etüt</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let analysis of getStudentAttendanceAnalysis()">
                <td class="student-info">
                  <div class="student-details">
                    <img [src]="analysis.avatar || getDefaultAvatar(analysis.name)" 
                         class="student-avatar" [alt]="analysis.name">
                    <div class="student-data">
                      <span class="student-name">{{ analysis.name }}</span>
                      <span class="student-email">{{ analysis.email }}</span>
                    </div>
                  </div>
                </td>
                <td class="total-records">{{ analysis.totalRecords }}</td>
                <td class="present-total">{{ analysis.present.total }}</td>
                <td class="present-normal">{{ analysis.present.normal }}</td>
                <td class="present-ek">{{ analysis.present.ek_ders }}</td>
                <td class="present-etut">{{ analysis.present.etut_dersi }}</td>
                <td class="absent-total">{{ analysis.absent.total }}</td>
                <td class="absent-normal">{{ analysis.absent.normal }}</td>
                <td class="absent-ek">{{ analysis.absent.ek_ders }}</td>
                <td class="absent-etut">{{ analysis.absent.etut_dersi }}</td>
                <td class="attendance-percentage">
                  <div class="percentage-badge" 
                       [class.high]="analysis.attendancePercentage >= 80"
                       [class.medium]="analysis.attendancePercentage >= 60 && analysis.attendancePercentage < 80"
                       [class.low]="analysis.attendancePercentage < 60">
                    {{ analysis.attendancePercentage }}%
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && !currentStudent" class="empty-state">
    <div class="empty-icon">
      <i class="bi bi-person-x"></i>
    </div>
    <h3>Öğrenci Bilgisi Bulunamadı</h3>
    <p>Lütfen giriş bilgilerinizi kontrol ediniz.</p>
  </div>

  <!-- Hidden PDF Content -->
  <div id="ucretSayfasi" style="display: none;">
    <div class="pdf-content" *ngIf="studentStats">
      <div class="pdf-header">
        <h1>Ücret ve Ödeme Raporu</h1>
        <p>{{ studentStats.student_info.name }}</p>
        <p>Tarih: {{ getCurrentDate() | date:'dd/MM/yyyy' }}</p>
      </div>

      <div class="pdf-stats">
        <div class="pdf-stat">
          <label>Toplam Borç:</label>
          <span>{{ formatCurrency(getTotalDebtAmount()) }}</span>
        </div>
        <div class="pdf-stat">
          <label>Toplam Ödenen:</label>
          <span>{{ formatCurrency(getTotalPaidAmount()) }}</span>
        </div>
        <div class="pdf-stat">
          <label>Kalan Borç:</label>
          <span>{{ formatCurrency(Math.abs(getRemainingDebt())) }}</span>
        </div>
      </div>

      <div class="pdf-payments" *ngIf="paymentHistory.length > 0">
        <h3>Ödeme Geçmişi</h3>
        <table>
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Tutar</th>
              <th>Açıklama</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let payment of paymentHistory">
              <td>{{ formatDate(payment.odeme_tarihi) }}</td>
              <td>{{ formatCurrency(payment.tutar) }}</td>
              <td>{{ payment.aciklama || 'Ders ücreti' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>
