<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="page-header">
        <h2><i class="bi bi-credit-card me-2"></i>Ücret Bilgileri</h2>
        <p class="text-muted">Ders ücretleri ve ödeme durumları</p>
      </div>
    </div>
  </div>

  <!-- Öğrenci Bilgi Kartları -->
  <div class="row" *ngIf="studentAnalysis.length > 0">
    <div class="col-12">
      <h4 class="mb-3">Öğrenci Bilgi Kartları</h4>
    </div>
    <div class="col-md-6 col-lg-4 mb-4" *ngFor="let student of studentAnalysis">
      <div class="student-card">
        <div class="student-card-header">
          <img [src]="student.avatar || getDefaultAvatar(student.name)" 
               class="student-avatar" 
               alt="Avatar">
          <div class="student-info">
            <h6 class="student-name">{{ student.name }}</h6>
            <p class="student-email">{{ student.email }}</p>
          </div>
        </div>
        <div class="student-card-body">
          <div class="stat-row">
            <span class="stat-label">Ders Ücreti:</span>
            <span class="stat-value">{{ formatCurrency(student.ucret) }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Katıldığı Ders:</span>
            <span class="stat-value">{{ student.presentCount }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Beklenen Tutar:</span>
            <span class="stat-value">{{ formatCurrency(student.expectedTotalAmount) }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Katılım Oranı:</span>
            <span class="stat-value">
              <span class="badge bg-{{ getAttendanceColor(student.attendancePercentage) }}">
                %{{ student.attendancePercentage }}
              </span>
            </span>
          </div>
        </div>
        <div class="student-card-footer">
          <button class="btn btn-primary btn-sm" 
                  (click)="loadStudentDetailedStats(student.id)">
            <i class="bi bi-graph-up me-1"></i>
            Detaylı İstatistikleri Gör
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bilgi mesajı -->
  <div class="row" *ngIf="studentAnalysis.length === 0">
    <div class="col-12">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        Henüz öğrenci bilgisi bulunmamaktadır.
      </div>
    </div>
  </div>
</div>

<!-- Student Detail Modal -->
<div class="modern-modal-overlay" *ngIf="showStudentStatsModal" (click)="closeStudentStatsModal()">
  <div class="modern-modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modern-modal-header">
      <div class="modal-title-section">
        <div class="modal-icon">
          <i class="bi bi-graph-up"></i>
        </div>
        <div class="modal-title-text">
          <h4>Öğrenci Detay İstatistikleri</h4>
          <p *ngIf="selectedStudentStats">{{ selectedStudentStats.student_info.name }}</p>
        </div>
      </div>
      <button type="button" class="modern-close-btn" (click)="closeStudentStatsModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <div class="modern-modal-body" *ngIf="selectedStudentStats">
      <!-- Öğrenci Temel Bilgileri -->
      <div class="student-basic-info mb-4">
        <div class="row">
          <div class="col-md-6">
            <div class="info-card">
              <h6><i class="bi bi-person-fill me-2"></i>Öğrenci Bilgileri</h6>
              <div class="info-item">
                <span class="label">Ad Soyad:</span>
                <span class="value">{{ selectedStudentStats.student_info.name }}</span>
              </div>
              <div class="info-item">
                <span class="label">E-posta:</span>
                <span class="value">{{ selectedStudentStats.student_info.email }}</span>
              </div>
              <div class="info-item">
                <span class="label">Grup:</span>
                <span class="value">{{ selectedStudentStats.student_info.grup }}</span>
              </div>
              <div class="info-item">
                <span class="label">Ders Ücreti:</span>
                <span class="value">{{ formatCurrency(selectedStudentStats.student_info.ucret) }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-card">
              <h6><i class="bi bi-graph-up me-2"></i>Katılım İstatistikleri</h6>
              <div class="info-item">
                <span class="label">Konu Anlatımı Dersi:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.total_lessons }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katıldığı Ders:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.present_count }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katılmadığı Ders:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.absent_count }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katılım Oranı:</span>
                <span class="value badge bg-success">%{{ selectedStudentStats.attendance_stats.attendance_percentage }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ödeme İstatistikleri -->
      <div class="payment-stats mb-4">
        <div class="info-card">
          <h6><i class="bi bi-credit-card me-2"></i>Ödeme İstatistikleri</h6>
          <div class="row">
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ selectedStudentStats.payment_stats.expected_payment_cycles }}</div>
                <div class="stat-label">Beklenen Dönem</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ formatCurrency(selectedStudentStats.payment_stats.expected_total_amount) }}</div>
                <div class="stat-label">Beklenen Tutar</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ formatCurrency(selectedStudentStats.payment_stats.total_paid) }}</div>
                <div class="stat-label">Ödenen Tutar</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value" [class.text-danger]="selectedStudentStats.payment_stats.debt > 0">
                  {{ formatCurrency(selectedStudentStats.payment_stats.debt) }}
                </div>
                <div class="stat-label">Borç</div>
              </div>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <div class="stat-item">
                <div class="stat-value">{{ selectedStudentStats.payment_stats.lessons_until_next_payment }}</div>
                <div class="stat-label">Sonraki Ödemeye Kalan Ders</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="stat-item">
                <div class="stat-value">{{ selectedStudentStats.payment_stats.payment_count }}</div>
                <div class="stat-label">Yapılan Ödeme Sayısı</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Son Devamsızlık Kayıtları -->
      <div class="recent-attendance mb-4">
        <div class="info-card">
          <h6><i class="bi bi-calendar-check me-2"></i>Son Devamsızlık Kayıtları</h6>
          <div class="attendance-list">
            <div class="attendance-item" *ngFor="let record of selectedStudentStats.recent_attendance">
              <div class="attendance-date">
                {{ formatDate(record.tarih) }}
                <span class="attendance-time">{{ formatTime(record.zaman) }}</span>
              </div>
              <div class="attendance-status">
                <span class="badge" 
                      [class.bg-success]="record.durum === 'Katıldı'"
                      [class.bg-danger]="record.durum === 'Katılmadı'">
                  {{ record.durum }}
                </span>
                <span class="badge bg-info ms-1" *ngIf="record.ders_tipi">
                  {{ record.ders_tipi === 'normal' ? 'Normal' : 
                     record.ders_tipi === 'ek_ders' ? 'Ek Ders' : 'Etüt' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <h2><i class="bi bi-credit-card me-2"></i>Ücret Bilgileri</h2>
      <p class="text-muted">Ders ücretleri ve ödeme durumunuzu buradan takip edebilirsiniz.</p>
    </div>
  </div>

  <!-- Öğrenci Bilgi Kartları -->
  <div class="row mb-4" *ngIf="studentStats.length > 0">
    <div class="col-12">
      <h4><i class="bi bi-person-badge me-2"></i>Öğrenci Bilgilerim</h4>
    </div>
    <div class="col-lg-6 col-xl-4 mb-4" *ngFor="let student of studentStats">
      <div class="student-card">
        <div class="student-card-header">
          <img [src]="student.avatar || getDefaultAvatar(student.name)" 
               class="student-avatar" 
               alt="Avatar">
          <div class="student-info">
            <h5 class="student-name">{{ student.name }}</h5>
            <p class="student-email">{{ student.email }}</p>
            <span class="badge bg-primary">{{ formatCurrency(student.ucret) }}/Ders</span>
          </div>
        </div>

        <div class="student-card-body">
          <div class="stat-row">
            <span class="stat-label">Toplam Ders:</span>
            <span class="stat-value">{{ student.totalLessons }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Katıldığı Ders:</span>
            <span class="stat-value text-success">{{ student.presentCount }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Katılmadığı Ders:</span>
            <span class="stat-value text-danger">{{ student.absentCount }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Sonraki Ödemeye Kalan:</span>
            <span class="stat-value">{{ student.lessonsUntilNextPayment }} Ders</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Beklenen Tutar:</span>
            <span class="stat-value">{{ formatCurrency(student.expectedTotalAmount) }}</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Katılım Oranı:</span>
            <span class="stat-value">
              <span class="badge bg-{{ getAttendanceColor(student.attendancePercentage) }}">
                %{{ student.attendancePercentage }}
              </span>
            </span>
          </div>
        </div>
        <div class="student-card-footer">
          <button class="btn btn-primary btn-sm" 
                  (click)="loadStudentDetailedStats(student.id)">
            <i class="bi bi-graph-up me-1"></i>
            Detaylı İstatistikleri Gör
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Ders Geçmişi ve Devamsızlık Analizi -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5><i class="bi bi-clock-history me-2"></i>Ders Geçmişim ve Devamsızlık Analizi</h5>
          <button class="btn btn-outline-primary btn-sm" (click)="toggleHistoricalView()">
            <i class="bi" [class]="viewHistoricalData ? 'bi-eye-slash' : 'bi-eye'"></i>
            {{ viewHistoricalData ? 'Gizle' : 'Göster' }}
          </button>
        </div>

        <div class="card-body" *ngIf="viewHistoricalData">
          <!-- Özet İstatistikler -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="stat-card bg-primary text-white">
                <div class="stat-icon">
                  <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ getTotalLessonsCount() }}</h3>
                  <p>Toplam Ders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-success text-white">
                <div class="stat-icon">
                  <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ getTotalPresentInPeriod() }}</h3>
                  <p>Katıldığım Ders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-danger text-white">
                <div class="stat-icon">
                  <i class="bi bi-x-circle"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ getTotalAbsentInPeriod() }}</h3>
                  <p>Katılmadığım Ders</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-info text-white">
                <div class="stat-icon">
                  <i class="bi bi-percent"></i>
                </div>
                <div class="stat-content">
                  <h3>%{{ getAttendancePercentage() }}</h3>
                  <p>Katılım Oranım</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Devamsızlık Analiz Tablosu -->
          <div class="analysis-section mb-4" *ngIf="getStudentAttendanceAnalysis()">
            <h5 class="mb-3">
              <i class="bi bi-table me-2"></i>Devamsızlık Analiz Tablomu
            </h5>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead class="table-dark">
                  <tr>
                    <th>Ders Tipi</th>
                    <th>Katıldım</th>
                    <th>Katılmadım</th>
                    <th>Toplam</th>
                    <th>Katılım Oranı</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><span class="badge bg-primary">Normal Ders</span></td>
                    <td class="text-success">{{ getStudentAttendanceAnalysis().present.normal }}</td>
                    <td class="text-danger">{{ getStudentAttendanceAnalysis().absent.normal }}</td>
                    <td>{{ getStudentAttendanceAnalysis().present.normal + getStudentAttendanceAnalysis().absent.normal }}</td>
                    <td>
                      <span class="badge bg-success" *ngIf="(getStudentAttendanceAnalysis().present.normal + getStudentAttendanceAnalysis().absent.normal) > 0">
                        %{{ Math.round((getStudentAttendanceAnalysis().present.normal / (getStudentAttendanceAnalysis().present.normal + getStudentAttendanceAnalysis().absent.normal)) * 100) }}
                      </span>
                      <span class="badge bg-secondary" *ngIf="(getStudentAttendanceAnalysis().present.normal + getStudentAttendanceAnalysis().absent.normal) === 0">
                        %0
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td><span class="badge bg-warning">Ek Ders</span></td>
                    <td class="text-success">{{ getStudentAttendanceAnalysis().present.ek_ders }}</td>
                    <td class="text-danger">{{ getStudentAttendanceAnalysis().absent.ek_ders }}</td>
                    <td>{{ getStudentAttendanceAnalysis().present.ek_ders + getStudentAttendanceAnalysis().absent.ek_ders }}</td>
                    <td>
                      <span class="badge bg-success" *ngIf="(getStudentAttendanceAnalysis().present.ek_ders + getStudentAttendanceAnalysis().absent.ek_ders) > 0">
                        %{{ Math.round((getStudentAttendanceAnalysis().present.ek_ders / (getStudentAttendanceAnalysis().present.ek_ders + getStudentAttendanceAnalysis().absent.ek_ders)) * 100) }}
                      </span>
                      <span class="badge bg-secondary" *ngIf="(getStudentAttendanceAnalysis().present.ek_ders + getStudentAttendanceAnalysis().absent.ek_ders) === 0">
                        %0
                      </span>
                    </td>
                  </tr>
                  <tr>
                    <td><span class="badge bg-info">Etüt Dersi</span></td>
                    <td class="text-success">{{ getStudentAttendanceAnalysis().present.etut_dersi }}</td>
                    <td class="text-danger">{{ getStudentAttendanceAnalysis().absent.etut_dersi }}</td>
                    <td>{{ getStudentAttendanceAnalysis().present.etut_dersi + getStudentAttendanceAnalysis().absent.etut_dersi }}</td>
                    <td>
                      <span class="badge bg-success" *ngIf="(getStudentAttendanceAnalysis().present.etut_dersi + getStudentAttendanceAnalysis().absent.etut_dersi) > 0">
                        %{{ Math.round((getStudentAttendanceAnalysis().present.etut_dersi / (getStudentAttendanceAnalysis().present.etut_dersi + getStudentAttendanceAnalysis().absent.etut_dersi)) * 100) }}
                      </span>
                      <span class="badge bg-secondary" *ngIf="(getStudentAttendanceAnalysis().present.etut_dersi + getStudentAttendanceAnalysis().absent.etut_dersi) === 0">
                        %0
                      </span>
                    </td>
                  </tr>
                  <tr class="table-info">
                    <td><strong>TOPLAM</strong></td>
                    <td class="text-success"><strong>{{ getStudentAttendanceAnalysis().present.total }}</strong></td>
                    <td class="text-danger"><strong>{{ getStudentAttendanceAnalysis().absent.total }}</strong></td>
                    <td><strong>{{ getStudentAttendanceAnalysis().totalRecords }}</strong></td>
                    <td>
                      <span class="badge bg-primary">
                        <strong>%{{ getStudentAttendanceAnalysis().attendancePercentage }}</strong>
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Tarih Filtreleri -->
          <div class="filters-section mb-4">
            <div class="card">
              <div class="card-header">
                <h6><i class="bi bi-filter me-2"></i>Tarih Filtreleri</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" class="form-control" [(ngModel)]="startDate">
                  </div>
                  <div class="col-md-3">
                    <label>Bitiş Tarihi</label>
                    <input type="date" class="form-control" [(ngModel)]="endDate">
                  </div>
                  <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-primary me-2" (click)="loadHistoricalAttendanceByDateRange()">
                      <i class="bi bi-search"></i> Filtrele
                    </button>
                    <div class="btn-group">
                      <button class="btn btn-outline-secondary btn-sm" (click)="setDateRangeLastWeek()">Son 7 Gün</button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="setDateRangeLastMonth()">Son 30 Gün</button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="setDateRangeThisMonth()">Bu Ay</button>
                      <button class="btn btn-outline-secondary btn-sm" (click)="setDateRangeThisYear()">Bu Yıl</button>
                      <button class="btn btn-outline-info btn-sm" (click)="loadAllAttendanceRecords()">Tümü</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ders Geçmişi Timeline -->
          <div class="timeline-section" *ngIf="groupedAttendanceByDate.length > 0">
            <h5 class="mb-3">
              <i class="bi bi-clock-history me-2"></i>Ders Geçmişim
            </h5>
            <div class="timeline">
              <div class="timeline-item" *ngFor="let dateGroup of groupedAttendanceByDate">
                <div class="timeline-date">
                  <div class="date-badge">
                    <div class="day">{{ formatDate(dateGroup.tarih) }}</div>
                    <div class="weekday">{{ getDayName(dateGroup.tarih) }}</div>
                  </div>
                </div>
                <div class="timeline-content">
                  <div class="attendance-summary">
                    <div class="summary-stats">
                      <span class="present-count">
                        <i class="bi bi-check-circle"></i>
                        {{ dateGroup.katilan_sayisi }} Katıldı
                      </span>
                      <span class="absent-count">
                        <i class="bi bi-x-circle"></i>
                        {{ dateGroup.katilmayan_sayisi }} Katılmadı
                      </span>
                    </div>

                    <!-- O tarihteki katılım durumumu göster -->
                    <div class="my-attendance-status">
                      <ng-container *ngFor="let record of historicalAttendance">
                        <div *ngIf="record.tarih === dateGroup.tarih" class="attendance-record">
                          <span class="badge" [class]="record.durum === 'present' ? 'bg-success' : 'bg-danger'">
                            <i class="bi" [class]="record.durum === 'present' ? 'bi-check-lg' : 'bi-x-lg'"></i>
                            {{ record.durum === 'present' ? 'Katıldım' : 'Katılmadım' }}
                          </span>
                          <span class="badge bg-secondary ms-2">
                            {{ record.ders_tipi === 'ek_ders' ? 'Ek Ders' : 
                                record.ders_tipi === 'etut_dersi' ? 'Etüt Dersi' : 'Normal Ders' }}
                          </span>
                          <small class="text-muted ms-2">{{ formatTime(record.zaman) }}</small>
                        </div>
                      </ng-container>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Veri Yoksa Mesaj -->
          <div class="text-center py-4" *ngIf="groupedAttendanceByDate.length === 0">
            <i class="bi bi-info-circle text-muted" style="font-size: 3rem;"></i>
            <h5 class="text-muted mt-3">Henüz ders kaydı bulunmuyor</h5>
            <p class="text-muted">Derslere katıldıkça burada geçmişinizi görebileceksiniz.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>