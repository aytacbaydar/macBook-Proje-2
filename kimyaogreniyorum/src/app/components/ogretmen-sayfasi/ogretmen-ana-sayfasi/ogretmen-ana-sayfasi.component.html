<div class="dashboard-container">
  <!-- Modern Header Section -->
  <div class="modern-page-header">
    <div class="header-content">
      <!-- Quick Stats Overview -->
      <div class="admin-overview">
        <div class="stat-card mavi">
          <div class="stat-icon">
            <i class="fas fa-users"></i>
          </div>
          <div class="stat-content">
            <h3>{{ dashboardStats.totalStudents }}</h3>
            <p>Toplam Öğrenci</p>
          </div>
        </div>

        <div class="stat-card yesil">
          <div class="stat-icon">
            <i class="fas fa-user-check"></i>
          </div>
          <div class="stat-content">
            <h3>{{ dashboardStats.activeStudents }}</h3>
            <p>Aktif Öğrenci</p>
          </div>
        </div>

        <div class="stat-card turuncu">
          <div class="stat-icon">
            <i class="fas fa-layer-group"></i>
          </div>
          <div class="stat-content">
            <h3>{{ dashboardStats.totalGroups }}</h3>
            <p>Aktif Grup</p>
          </div>
        </div>

        <div class="stat-card mor">
          <div class="stat-icon">
            <i class="fas fa-money-bill-wave"></i>
          </div>
          <div class="stat-content">
            <h3>{{ isLoadingMonthlyStats ? 'Yükleniyor...' : formatCurrency(monthlyPaymentStats.totalReceived) }}</h3>
            <p>Bu Ay Ödenen</p>
          </div>
        </div>
      </div>

      <!-- Ek İstatistikler -->
      <div class="additional-stats">
        <div class="stat-card kirmizi">
          <div class="stat-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="stat-content">
            <h3>{{ isLoadingMonthlyStats ? '...' : (monthlyPaymentStats.totalTests || '0') }}</h3>
            <p>Deneme Sınavı</p>
          </div>
        </div>

        <div class="stat-card cyan">
          <div class="stat-icon">
            <i class="fas fa-question-circle"></i>
          </div>
          <div class="stat-content">
            <h3>{{ isLoadingMonthlyStats ? '...' : (monthlyPaymentStats.totalQuestions || '0') }}</h3>
            <p>Toplam Soru</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="admin-grid">
    <!-- New Students -->
    <div class="admin-container grid-6">
      <div class="card-header mavi">
        <h3>
          <i class="bi bi-person-plus-fill me-2"></i>
          Yeni Kayıt Olan Öğrenciler
        </h3>
        <span class="badge bg-primary">{{ newStudents.length }}</span>
      </div>

      <div class="card-body">
        <!-- Debug bilgisi (geliştirme aşamasında) -->
        <div class="debug-info mb-2" style="font-size: 12px; color: #666;">
          Toplam yeni kayıt: {{ newStudents.length }}, Loading: {{ isLoadingNewStudents }}
        </div>

        <div *ngIf="isLoadingNewStudents" class="loading-state text-center p-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
          </div>
          <p class="mt-2 text-muted">Yeni kayıtlar yükleniyor...</p>
        </div>

        <div *ngIf="!isLoadingNewStudents && newStudents && newStudents.length > 0" class="new-students-list">
          <div *ngFor="let student of newStudents; trackBy: trackByStudentId" class="new-student-item">
            <div class="student-info">
              <img [src]="student.avatar || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(student.adi_soyadi) + '&background=4f46e5&color=fff&size=60&font-size=0.6&rounded=true'" 
                   alt="Avatar" class="student-avatar">
              <div class="student-details">
                <h4>{{ student.adi_soyadi }}</h4>
                <p class="student-email">{{ student.email }}</p>
                <p class="student-school" *ngIf="student.okulu">{{ student.okulu }} - {{ student.sinifi }}</p>
                <p class="student-date">{{ formatDate(student.kayit_tarihi || student.created_at) }}</p>
                <p class="student-status" style="font-size: 11px; color: #888;">
                  Rütbe: {{ student.rutbe || 'Belirsiz' }}, Öğretmen: {{ student.ogretmeni || 'Atanmamış' }}
                </p>
              </div>
            </div>
            <div class="student-actions">
              <button class="approve-btn" (click)="approveNewStudent(student.id)" title="Onayla">
                <i class="bi bi-check-circle"></i>
              </button>
              <button class="reject-btn" (click)="rejectNewStudent(student.id)" title="Reddet">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoadingNewStudents && (!newStudents || newStudents.length === 0)" class="empty-state">
          <i class="bi bi-person-check fs-1 text-muted"></i>
          <p class="text-muted mt-2">Yeni kayıt olan öğrenci bulunmuyor.</p>
          <button class="btn btn-sm btn-outline-primary mt-2" (click)="loadNewStudents()">
            <i class="bi bi-arrow-clockwise me-1"></i>
            Yenile
          </button>
        </div>
      </div>
    </div>

    <!-- Last Exam Results -->
    <div class="admin-container grid-6">
      <div class="card-header turuncu">
        <h3>
          <i class="fas fa-chart-bar me-2"></i>
          Son Sınav Sonuçları
        </h3>
        <div class="card-actions">
          <button class="header-action-btn detail-btn" (click)="navigateToExamResults()">
            <i class="bi bi-clipboard-check-fill"></i>
            <span>Tüm Sonuçlar</span>
          </button>
        </div>
      </div>
      <div class="card-body">
        <div *ngIf="isLoadingLastExam" class="loading-state">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Yükleniyor...</span>
        </div>

        <div class="exam-results-list" *ngIf="!isLoadingLastExam && lastExamResults.length > 0">
          <div class="exam-result-item" *ngFor="let result of lastExamResults">
            <div class="student-info">
              <div class="student-avatar">
                <i class="bi bi-person-circle"></i>
              </div>
              <div class="student-details">
                <h4>{{ result.ogrenci_adi }}</h4>
                <p class="exam-name">{{ result.sinav_adi }}</p>
              </div>
            </div>
            <div class="result-stats">
              <div class="stat-grid">
                <div class="stat-item success">
                  <span class="stat-value">{{ result.dogru_sayisi }}</span>
                  <span class="stat-label">D</span>
                </div>
                <div class="stat-item error">
                  <span class="stat-value">{{ result.yanlis_sayisi }}</span>
                  <span class="stat-label">Y</span>
                </div>
                <div class="stat-item info">
                  <span class="stat-value">{{ calculateNet(result) | number:'1.1-1' }}</span>
                  <span class="stat-label">Net</span>
                </div>
              </div>
              <div class="performance-badge" [ngClass]="getPerformanceClass(result.yuzde)">
                {{ result.yuzde }}%
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoadingLastExam && lastExamResults.length === 0" class="empty-state">
          <i class="bi bi-file-earmark-text text-muted"></i>
          <p class="text-muted mt-2">Henüz sınav sonucu bulunmuyor.</p>
        </div>
      </div>
    </div>

    <!-- Today's Schedule -->
    <div class="admin-container grid-8">
      <div class="card-header yesil">
        <h3>
          <i class="fas fa-calendar-day me-2"></i>
          Bugünkü Derslerim ({{ todayName }})
        </h3>
        <div class="card-actions">
          <button class="header-action-btn detail-btn" (click)="haftalikdersprogrami()">
            <i class="bi bi-clipboard-check-fill"></i>
            <span>Haftalık Program</span>
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="today-schedule" *ngIf="dailySchedule.length > 0; else noLessonsToday">
          <div class="lesson-item" *ngFor="let ders of dailySchedule">
            <div class="lesson-time">
              <i class="fas fa-clock me-2"></i>
              {{ ders.ders_saati }}
            </div>
            <div class="lesson-info">
              <div class="group-name">
                <i class="fas fa-users me-1"></i>
                {{ ders.grup_adi }}
              </div>
              <div class="students-list" *ngIf="ders.ogrenciler && ders.ogrenciler.length > 0">
                <span class="student-count">
                  {{ ders.ogrenciler.length }} öğrenci
                </span>
                <div class="student-names">
                  {{ ders.ogrenciler.join(', ') }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #noLessonsToday>
          <div class="no-lessons">
            <i class="fas fa-calendar-check"></i>
            <p>Bugün ders bulunmamaktadır.</p>
          </div>
        </ng-template>
      </div>
    </div>

    <!-- Upcoming Payments -->
    <div class="admin-container grid-4">
      <div class="card-header mor">
        <h3>
          <i class="fas fa-money-bill me-2"></i>
          Yaklaşan Ödemeler
        </h3>
        <div class="card-actions">
          <button class="header-action-btn detail-btn" (click)="yaklasanodemeler()">
            <i class="bi bi-clipboard-check-fill"></i>
            <span>Tümünü Gör</span>
          </button>
        </div>
      </div>
      <div class="card-body">
        <div *ngIf="isLoadingPayments" class="loading-state">
          <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
          <span class="ms-2">Yükleniyor...</span>
        </div>

        <div class="payment-list" *ngIf="!isLoadingPayments">
          <div class="payment-item" *ngFor="let payment of upcomingPayments.slice(0, 4)">
            <div class="payment-info">
              <div class="student-details">
                <h4>{{ payment.adi_soyadi }}</h4>
                <p>{{ payment.grubu }} • {{ payment.ders_sayisi }} ders</p>
              </div>
              <div class="payment-amount">
                <span class="amount">{{ formatCurrency(payment.ucret) }}</span>
                <span class="due-date" *ngIf="payment.son_odeme_tarihi">
                  {{ payment.son_odeme_tarihi | date:'dd/MM' }}
                </span>
              </div>
            </div>
            <div class="payment-status pending">
              <i class="bi bi-clock"></i>
            </div>
          </div>

          <div *ngIf="upcomingPayments.length === 0" class="no-payments">
            <i class="bi bi-check-circle text-success"></i>
            <p>Tüm ödemeler tamamlandı!</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Yaklaşan Dersler
    <div class="admin-container grid-4">
      <div class="card-header">
        <h3>
          <i class="fas fa-calendar-alt me-2"></i>
          Yaklaşan Dersler
        </h3>
        <div class="card-actions">
          <a routerLink="/ogretmen-sayfasi/ogretmen-haftalik-program-sayfasi" class="btn-primary btn-sm">Program</a>
        </div>
      </div>
      <div class="card-body">
        <div *ngIf="isLoadingClasses" class="loading-state">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Yükleniyor...</span>
        </div>

        <div class="class-list" *ngIf="!isLoadingClasses">
          <div class="class-item" *ngFor="let class of upcomingClasses">
            <div class="class-time">
              <span class="time">{{ class.time }}</span>
              <span class="duration">{{ class.duration }}</span>
            </div>
            <div class="class-info">
              <h4>{{ class.subject }}</h4>
              <p>{{ class.group }} • {{ class.studentCount }} Öğrenci</p>
            </div>
            <div class="class-status" [ngClass]="class.status">
              <i class="fas" [ngClass]="class.status === 'active' ? 'fa-play' : 'fa-clock'"></i>
            </div>
          </div>
        </div>
      </div>
    </div>-->

    <!-- Student Progress -->
    <div class="admin-container grid-12">
      <div class="card-header turuncu">
        <h3>
          <i class="fas fa-chart-pie me-2"></i>
          Öğrenci İlerlemesi
        </h3>
        <div class="card-actions">
          <button class="header-action-btn detail-btn" (click)="konuanalizi()">
            <i class="bi bi-clipboard-check-fill"></i>
            <span>Konu Analizi</span>
          </button>
        </div>
      </div>
      <div class="card-body">
        <!--içerik-->
        <div class="worst-topics-container" *ngIf="!isLoadingWorstTopics && worstTopics.length > 0">
          <div class="worst-topics-header">
            <h4><i class="bi bi-exclamation-triangle-fill me-2 text-warning"></i>Geliştirilmesi Gereken Konular</h4>
            <p class="text-muted">En düşük başarı oranına sahip 5 konu</p>
          </div>

          <div class="worst-topics-list">
            <div class="worst-topic-item" *ngFor="let konu of worstTopics; let i = index">
              <div class="topic-rank">
                <span class="rank-number">{{ i + 1 }}</span>
              </div>

              <div class="topic-info">
                <h6 class="topic-name">{{ konu.konu_adi }}</h6>
                <div class="topic-stats">
                  <div class="stat-item">
                    <i class="bi bi-people-fill"></i>
                    <span>{{ konu.cevaplayan_ogrenci }}/{{ konu.toplam_ogrenci }} öğrenci</span>
                  </div>
                </div>
              </div>

              <div class="topic-performance">
                <div class="performance-badge" [style.background-color]="getWorstTopicColor(konu.ortalama_basari)">
                  {{ konu.ortalama_basari }}%
                </div>
                <div class="performance-text" [style.color]="getWorstTopicColor(konu.ortalama_basari)">
                  {{ getWorstTopicText(konu.ortalama_basari) }}
                </div>
              </div>

              <div class="progress-bar-container">
                <div class="progress-bar-bg">
                  <div class="progress-bar-fill" 
                       [style.width.%]="konu.ortalama_basari"
                       [style.background-color]="getWorstTopicColor(konu.ortalama_basari)">
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="worst-topics-actions">
            <button class="btn btn-outline-primary btn-sm" (click)="konuanalizi()">
              <i class="bi bi-bar-chart-line-fill me-1"></i>
              Detaylı Analiz
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div class="loading-container" *ngIf="isLoadingWorstTopics">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Yükleniyor...</span>
          </div>
          <p class="mt-2 text-muted">Konu analizi yükleniyor...</p>
        </div>

        <!-- Empty State -->
        <div class="empty-state" *ngIf="!isLoadingWorstTopics && worstTopics.length === 0">
          <div class="empty-icon">
            <i class="bi bi-clipboard-data"></i>
          </div>
          <h5>Henüz Konu Analizi Verisi Yok</h5>
          <p class="text-muted">Öğrencileriniz sınav çözdükçe burada analiz sonuçları görünecek.</p>
          <button class="btn btn-primary btn-sm" (click)="konuanalizi()">
            <i class="bi bi-plus-circle me-1"></i>
            Konu Analizine Git
          </button>
        </div>
        <!--içerik Son-->
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="admin-container grid-4">
      <div class="card-header mavi">
        <h3>
          <i class="fas fa-tachometer-alt me-2"></i>
          Özet İstatistikler
        </h3>
      </div>
      <div class="card-body">
        <div *ngIf="isLoadingStats" class="loading-state">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Yükleniyor...</span>
        </div>

        <div class="stats-mini" *ngIf="!isLoadingStats">
          <div class="mini-stat">
            <div class="mini-icon primary">
              <i class="fas fa-book"></i>
            </div>
            <div class="mini-content">
              <h4>{{ dashboardStats.totalTopics }}</h4>
              <p>Toplam Konu</p>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon success">
              <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="mini-content">
              <h4>{{ formatCurrency(dashboardStats.completedTopics) }}</h4>
              <p>Toplam Ücret</p>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon warning">
              <i class="fas fa-file-alt"></i>
            </div>
            <div class="mini-content">
              <h4>{{ dashboardStats.totalExams }}</h4>
              <p>Toplam Sınav</p>
            </div>
          </div>

          <div class="mini-stat">
            <div class="mini-icon info">
              <i class="fas fa-user-minus"></i>
            </div>
            <div class="mini-content">
              <h4>{{ dashboardStats.inactiveStudents }}</h4>
              <p>Pasif Öğrenci</p>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Duyurular -->
    <div class="admin-container grid-8">
      <div class="card-header turuncu">
        <h3>
          <i class="fas fa-bullhorn me-2"></i>
          Duyurular
        </h3>
        <div class="card-actions">
          <button class="header-action-btn detail-btn" (click)="duyuruEkle()">
            <i class="bi bi-plus-circle"></i>
            <span>Duyuru Ekle</span>
          </button>
        </div>
      </div>
      <div class="card-body">
        <!-- Loading State -->
        <div *ngIf="isLoadingAnnouncements" class="loading-state">
          <div class="spinner-border spinner-border-sm" role="status"></div>
          <span class="ms-2">Yükleniyor...</span>
        </div>

        <!-- Duyuru Listesi -->
        <div *ngIf="!isLoadingAnnouncements && announcements.length > 0" class="announcements-list">
          <div class="announcement-item" *ngFor="let announcement of announcements">
            <div class="announcement-header">
              <div class="announcement-type" [ngClass]="getAnnouncementTypeClass(announcement.grup!)">
                <i class="fas" [ngClass]="announcement.grup ? 'fa-users' : 'fa-globe'"></i>
                <span>{{ getAnnouncementTypeText(announcement.grup!) }}</span>
              </div>
              <div class="announcement-date">
                {{ formatAnnouncementDate(announcement.olusturma_tarihi!) }}
              </div>
              <button class="delete-announcement-btn" (click)="deleteAnnouncement(announcement.id!)" title="Duyuruyu Sil">
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="announcement-content">
              <h4 class="announcement-title">{{ announcement.baslik }}</h4>
              <p class="announcement-text">{{ announcement.icerik }}</p>
            </div>
          </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="!isLoadingAnnouncements && announcements.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-megaphone"></i>
          </div>
          <h5>Henüz Duyuru Bulunmuyor</h5>
          <p class="text-muted">İlk duyurunuzu oluşturmak için yukarıdaki butonu kullanın.</p>
          <button class="btn btn-primary btn-sm" (click)="duyuruEkle()">
            <i class="bi bi-plus-circle me-1"></i>
            İlk Duyuruyu Ekle
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  window.onscroll = function() {scrollFunction()};

  function scrollFunction() {
    const myBtn = document.getElementById("myBtn");
    if (myBtn) {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        myBtn.style.display = "block";
      } else {
        myBtn.style.display = "none";
      }
    }
  }
</script>

<!-- Duyuru Ekleme Modal -->
<div class="modal-overlay" *ngIf="showAnnouncementModal" (click)="closeAnnouncementModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="bi bi-megaphone"></i>
        Yeni Duyuru Ekle
      </h3>
      <button class="close-btn" (click)="closeAnnouncementModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="saveAnnouncement()" #announcementForm="ngForm">
        <div class="form-group">
          <label for="announcementTitle">Duyuru Başlığı *</label>
          <input 
            type="text" 
            id="announcementTitle"
            class="form-control" 
            [(ngModel)]="newAnnouncement.baslik" 
            name="baslik"
            placeholder="Duyuru başlığını girin..."
            required>
        </div>

        <div class="form-group">
          <label for="announcementContent">Duyuru İçeriği *</label>
          <textarea 
            id="announcementContent"
            class="form-control" 
            [(ngModel)]="newAnnouncement.icerik" 
            name="icerik"
            rows="4"
            placeholder="Duyuru içeriğini girin..."
            required></textarea>
        </div>

        <div class="form-group">
          <label for="announcementGroup">Hedef Grup</label>
          <select 
            id="announcementGroup"
            class="form-control" 
            [(ngModel)]="newAnnouncement.grup" 
            name="grup">
            <option value="">Genel Duyuru (Tüm Öğrenciler)</option>
            <option *ngFor="let group of groupsList" [value]="group">{{ group }}</option>
          </select>
          <small class="form-text text-muted">
            Grup seçilmezse duyuru tüm öğrencilere gönderilir
          </small>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeAnnouncementModal()">
            İptal
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!announcementForm.valid">
            <i class="bi bi-check-circle me-1"></i>
            Duyuru Ekle
          </button>
        </div>
      </form>
    </div>
  </div>
</div>