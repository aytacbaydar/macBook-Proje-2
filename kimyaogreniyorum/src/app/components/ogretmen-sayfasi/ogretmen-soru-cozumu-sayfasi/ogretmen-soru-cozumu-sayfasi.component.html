<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-content">
      <div class="back-button" *ngIf="viewMode === 'student'" (click)="backToAllMessages()">
        <i class="bi bi-arrow-left"></i>
      </div>
      <div class="header-info">
        <h3 *ngIf="viewMode === 'all'">Öğrenci Mesajları</h3>
        <h3 *ngIf="viewMode === 'student' && selectedStudent">{{ selectedStudent.adi_soyadi }}</h3>
      </div>
      <div class="header-actions">
        <div class="notification-toggle">
          <label class="switch">
            <input type="checkbox" [checked]="notificationsEnabled" (change)="toggleNotifications($event)">
            <span class="slider"></span>
          </label>
          <span class="notification-text">Bildirim</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading States -->
  <div class="loading-overlay" *ngIf="isLoading || isLoadingMessages || isLoadingStudents">
    <div class="spinner"></div>
    <p>Yükleniyor...</p>
  </div>

  <!-- Error Message -->
  <div class="error-message" *ngIf="error && !isLoading">
    <i class="bi bi-exclamation-triangle"></i>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadAllMessages()">Tekrar Dene</button>
  </div>

  <!-- Student Avatars Row -->
  <div class="student-avatars-container" *ngIf="viewMode === 'all' && !isLoading && !error && students.length > 0">
    <div class="avatars-scroll">
      <div class="student-avatar-item" 
           *ngFor="let student of students; trackBy: trackByStudentId"
           (click)="selectStudent(student)"
           [title]="student.adi_soyadi">
        <div class="avatar-wrapper" [class.has-unread]="getUnreadMessageCount(student.id) > 0">
          <img [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
               [alt]="student.adi_soyadi" 
               class="student-avatar-img">
          <div class="unread-badge" *ngIf="getUnreadMessageCount(student.id) > 0">
            {{ getUnreadMessageCount(student.id) }}
          </div>
        </div>
        <span class="student-name-label">{{ student.adi_soyadi.split(' ')[0] }}</span>
      </div>
    </div>
  </div>

  <!-- All Students Toggle Button -->
  <div class="all-students-toggle" *ngIf="viewMode === 'all' && !isLoading && !error">
    <button class="toggle-all-students-btn" 
            (click)="toggleAllStudentsView()"
            [class.active]="showAllStudents">
      <i class="bi bi-people-fill me-2"></i>
      Tüm Öğrenciler ({{ students.length }})
      <i class="bi" [class.bi-chevron-down]="!showAllStudents" [class.bi-chevron-up]="showAllStudents"></i>
    </button>
  </div>

  <!-- Search Bar -->
  <div class="search-container" *ngIf="viewMode === 'all' && !isLoading && !error && showAllStudents">
    <div class="search-input-group">
      <i class="bi bi-search search-icon"></i>
      <input type="text" 
             class="search-input" 
             [(ngModel)]="studentSearchQuery"
             (input)="filterStudents()"
             placeholder="Öğrenci ara...">
      <button class="clear-search-btn" 
              *ngIf="studentSearchQuery" 
              (click)="clearSearch()">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>

  <!-- All Students List -->
  <div class="student-list" *ngIf="viewMode === 'all' && !isLoading && !error">
    <!-- Students with messages -->
    <div class="student-item" 
         *ngFor="let studentId of getFilteredStudentIds(); trackBy: trackByStudentIdNumber"
         (click)="selectStudentFromGroupedMessage(studentId)">
      <div class="student-avatar">
        <img [src]="getStudentById(studentId)?.avatar || getDefaultAvatar(getStudentName(studentId))" 
             alt="Avatar" class="avatar-img">
      </div>
      <div class="student-info">
        <div class="student-name">{{ getStudentName(studentId) }}</div>
        <div class="last-message" *ngIf="getLatestMessageForStudent(studentId) as lastMessage">
          <span class="message-preview">{{ lastMessage.mesaj_metni | slice:0:50 }}{{ lastMessage.mesaj_metni.length > 50 ? '...' : '' }}</span>
          <span class="message-time">{{ formatDate(lastMessage.gonderim_tarihi) }}</span>
        </div>
      </div>
      <div class="student-badges">
        <div class="message-count" *ngIf="getMessageCountForStudent(studentId) > 0">
          {{ getMessageCountForStudent(studentId) }}
        </div>
        <div class="unread-count" *ngIf="getUnreadMessageCount(studentId) > 0">
          {{ getUnreadMessageCount(studentId) }}
        </div>
      </div>
    </div>

    <!-- All students (including those without messages) -->
    <div class="students-section" *ngIf="showAllStudents">
      <div class="all-students-list">
        <div class="student-item" 
             *ngFor="let student of getFilteredStudents(); trackBy: trackByStudentId"
             (click)="selectStudent(student)"
             [class.has-messages]="hasMessages(student.id)">
          <div class="student-avatar">
            <img [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
                 alt="Avatar" class="avatar-img">
          </div>
          <div class="student-info">
            <div class="student-name">{{ student.adi_soyadi }}</div>
            <div class="student-details">
              <span class="student-email">{{ student.email }}</span>
              <span class="student-group" *ngIf="student.grubu">{{ student.grubu }}</span>
            </div>
          </div>
          <div class="student-badges">
            <div class="message-count" *ngIf="getStudentMessageCount(student.id) > 0">
              {{ getStudentMessageCount(student.id) }}
            </div>
            <div class="unread-count" *ngIf="getUnreadMessageCount(student.id) > 0">
              {{ getUnreadMessageCount(student.id) }}
            </div>
            <div class="no-messages" *ngIf="getStudentMessageCount(student.id) === 0">
              <i class="bi bi-chat" title="Henüz mesaj yok"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Chat View -->
  <div class="chat-view" *ngIf="viewMode === 'student' && selectedStudent && !isLoading && !error">
    <!-- Messages Container -->
    <div class="messages-container" #messageContainer>
      <div class="message-wrapper" 
           *ngFor="let message of studentMessages; trackBy: trackByMessageId"
           [class.sent]="message.gonderen_tip === 'ogretmen'"
           [class.received]="message.gonderen_tip === 'ogrenci'">

        <div class="message-bubble">
          <!-- Text Message -->
          <div class="message-text" *ngIf="message.mesaj_metni">
            {{ message.mesaj_metni }}
          </div>

          <!-- Image Message -->
          <div class="message-image" *ngIf="message.resim_url">
            <img [src]="message.resim_url" 
                 [alt]="getImageFileName(message.resim_url)"
                 (click)="openImageModal(message.resim_url)">
          </div>

          <!-- Message Info -->
          <div class="message-info">
            <span class="message-time">{{ formatDate(message.gonderim_tarihi) }}</span>
            <span class="message-sender" *ngIf="message.gonderen_tip === 'ogrenci'">{{ message.gonderen_adi }}</span>
            <i class="bi bi-check-all message-status" 
               *ngIf="message.gonderen_tip === 'ogretmen'"
               [class.read]="message.okundu"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Input -->
    <div class="message-input-container">
      <!-- File Preview -->
      <div class="file-preview" *ngIf="previewUrl">
        <img [src]="previewUrl" alt="Seçilen resim">
        <button class="remove-file" (click)="removeFile()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Input Area -->
      <div class="input-area">
        <button class="attach-btn" (click)="fileInput.click()">
          <i class="bi bi-paperclip"></i>
        </button>

        <input type="file" 
               #fileInput 
               (change)="onFileSelected($event)" 
               accept="image/*" 
               style="display: none">

        <textarea class="message-input" 
                  [(ngModel)]="yeniMesaj"
                  (keydown.enter)="handleEnterKeyPress($event)"
                  placeholder="Mesaj yazın... (Ctrl+Enter ile gönder)"
                  rows="1"></textarea>

        <button class="send-btn" 
                (click)="sendMessage()"
                [disabled]="isSending || (!yeniMesaj.trim() && !selectedFile)">
          <i class="bi bi-send" *ngIf="!isSending"></i>
          <div class="spinner-small" *ngIf="isSending"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="viewMode === 'all' && getFilteredStudentIds().length === 0 && !isLoading && !error">
    <i class="bi bi-chat-dots" *ngIf="!studentSearchQuery"></i>
    <i class="bi bi-search" *ngIf="studentSearchQuery"></i>
    <h3 *ngIf="!studentSearchQuery">Henüz mesaj yok</h3>
    <h3 *ngIf="studentSearchQuery">Arama sonucu bulunamadı</h3>
    <p *ngIf="!studentSearchQuery">Öğrencilerinizden mesaj geldiğinde burada görünecek.</p>
    <p *ngIf="studentSearchQuery">Farklı bir arama terimi deneyin.</p>
  </div>

  <!-- Image Modal -->
  <div class="image-modal" *ngIf="showImageModal" (click)="closeImageModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <img [src]="selectedImageUrl" [alt]="getImageFileName(selectedImageUrl)">
      <button class="close-modal" (click)="closeImageModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>
  </div>
</div>