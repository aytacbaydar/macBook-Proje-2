<div class="cevap-anahtari-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-key"></i>
        Cevap Anahtarı Yönetimi
      </h1>
      <p class="page-subtitle">Sınav cevap anahtarlarınızı oluşturun ve yönetin</p>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-content">
          <h3>{{ cevapAnahtarlari.length }}</h3>
          <p>Toplam Cevap Anahtarı</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getThisMonthCount() }}</h3>
          <p>Bu Ay Eklenen</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getActiveSinavCount() }}</h3>
          <p>Son Ay Aktif</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <!-- Filter Buttons -->
  <div class="filter-bar">
    <div class="filter-buttons">
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'ALL'"
        (click)="setFilter('ALL')">
        <i class="fas fa-list"></i>
        Tümü ({{ cevapAnahtarlari.length }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TYT'"
        (click)="setFilter('TYT')">
        <i class="fas fa-graduation-cap"></i>
        TYT ({{ getCountByType('TYT') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'AYT'"
        (click)="setFilter('AYT')">
        <i class="fas fa-book"></i>
        AYT ({{ getCountByType('AYT') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TAR'"
        (click)="setFilter('TAR')">
        <i class="fas fa-search"></i>
        Tarama ({{ getCountByType('TAR') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TEST'"
        (click)="setFilter('TEST')">
        <i class="fas fa-clipboard-list"></i>
        Test ({{ getCountByType('TEST') }})
      </button>
    </div>
  </div>



  <!-- Modern Bootstrap Modal -->

  <!-- Cevap Anahtarları Listesi -->
  <div *ngIf="!loading && filteredCevapAnahtarlari.length > 0" class="answer-keys-grid">
    <div *ngFor="let cevapAnahtari of filteredCevapAnahtarlari" class="answer-key-card">
      <div class="card-header">
        <h3>{{ cevapAnahtari.sinav_adi }}</h3>
        <span class="date-badge">{{ formatDate(cevapAnahtari.olusturma_tarihi) }}</span>
      </div>

      <div class="card-body">
        <div class="exam-info">
          <div class="info-item">
            <i class="bi bi-calendar-event"></i>
            <span>{{ formatDate(cevapAnahtari.sinav_tarihi) }}</span>
          </div>
          <div class="info-item">
            <i class="bi bi-clock"></i>
            <span>{{ cevapAnahtari.sinav_suresi }} dk</span>
          </div>
          <div class="info-item">
            <i class="bi bi-list-ol"></i>
            <span>{{ getSoruSayisi(cevapAnahtari.cevaplar) }} Soru</span>
          </div>
        </div>

        <div class="answer-preview">
          <h4>Cevap Anahtarı</h4>
          <div class="answers-row">
            <div *ngFor="let cevap of getAnswersArray(cevapAnahtari.cevaplar); let i = index" class="answer-item">
              <span class="question-number">{{ cevap.index }}</span>
              <span class="answer-letter">{{ cevap.value || '-' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn btn-outline-primary btn-sm" (click)="viewAnswerKey(cevapAnahtari)">
          <i class="bi bi-eye"></i>
          Görüntüle
        </button>
        <button class="btn btn-outline-warning btn-sm" (click)="editAnswerKey(cevapAnahtari)">
          <i class="bi bi-pencil"></i>
          Düzenle
        </button>
        <button class="btn btn-outline-danger btn-sm" (click)="deleteAnswerKey(cevapAnahtari.id)">
          <i class="bi bi-trash"></i>
          Sil
        </button>
      </div>
    </div>
  </div>

    <div *ngIf="!loading && filteredCevapAnahtarlari.length === 0" class="empty-state">
      <i class="fas fa-search"></i>
      <h3 *ngIf="selectedFilter === 'ALL' && !searchQuery">Henüz cevap anahtarı bulunmuyor</h3>
      <h3 *ngIf="selectedFilter !== 'ALL' || searchQuery">{{ getEmptyStateMessage() }}</h3>
      <p *ngIf="selectedFilter === 'ALL' && !searchQuery">İlk cevap anahtarınızı oluşturmak için yukarıdaki butonu kullanın.</p>
      <p *ngIf="selectedFilter !== 'ALL' || searchQuery">Farklı kriterlerle tekrar arayabilir veya yeni cevap anahtarı ekleyebilirsiniz.</p>
    </div>
  </div>


<div class="modern-modal" (click)="$event.stopPropagation()">
  <!-- Modal Header -->
  <div class="modal-header">
    <div class="modal-title">
      <i class="fas fa-sparkles"></i>
      <h2>Yeni Cevap Anahtarı</h2>
    </div>
    <button type="button" class="close-btn" (click)="closeAddModal()">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Modal Body -->
  <div class="modal-body">
    <form (ngSubmit)="onSubmit()" class="modern-form" #addForm="ngForm">
      <!-- Temel Bilgiler Card -->
      <div class="form-section">
        <div class="section-header">
          <i class="fas fa-info-circle"></i>
          <h3>Temel Bilgiler</h3>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-edit"></i>
              Sınav Adı *
            </label>
            <input 
              type="text"
              class="form-control modern-input" 
              [(ngModel)]="cevapAnahtari.sinav_adi" 
              name="sinav_adi"
              placeholder="Örn: TYT Deneme - 1. Hafta"
              required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-graduation-cap"></i>
              Sınav Türü *
            </label>
            <select 
              class="form-select modern-select" 
              [(ngModel)]="cevapAnahtari.sinav_turu" 
              name="sinav_turu" 
              required>
              <option value="">Sınav Türü Seçiniz</option>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">
                {{ tur.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-list-ol"></i>
              Soru Sayısı *
            </label>
            <input 
              type="number"
              class="form-control modern-input" 
              [(ngModel)]="cevapAnahtari.soru_sayisi" 
              name="soru_sayisi"
              min="1" 
              [max]="maxSoruSayisi"
              (ngModelChange)="onSoruSayisiChange()"
              required>
          </div>

          <div class="form-group">
            <label class="form-label">
              <i class="fas fa-calendar"></i>
              Sınav Tarihi *
            </label>
            <input 
              type="date"
              class="form-control modern-input" 
              [(ngModel)]="cevapAnahtari.tarih" 
              name="tarih"
              required>
          </div>
        </div>

        <!-- File Upload Section -->
        <div class="file-upload-section">
          <div class="upload-area" [class.has-file]="imagePreview">
            <input 
              type="file" 
              #fileInput
              accept="image/*"
              (change)="onFileSelected($event)"
              style="display: none">
            
            <div class="upload-content" *ngIf="!imagePreview" (click)="fileInput.click()">
              <i class="fas fa-cloud-upload-alt"></i>
              <p>Sınav kapağı yükleyin</p>
              <small>JPG, PNG veya GIF (Max: 5MB)</small>
            </div>

            <div class="file-preview" *ngIf="imagePreview">
              <img [src]="imagePreview" alt="Sınav Kapağı">
              <button type="button" class="remove-file" (click)="removeFile()">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Aktiflik Toggle -->
        <div class="toggle-section">
          <div class="form-check form-switch">
            <input 
              class="form-check-input modern-switch" 
              type="checkbox" 
              id="aktiflik"
              [(ngModel)]="cevapAnahtari.aktiflik" 
              name="aktiflik">
            <label class="form-check-label toggle-label" for="aktiflik">
              <i class="fas fa-toggle-on"></i>
              Aktif Durum
            </label>
          </div>
        </div>
      </div>

      <!-- Soru Detayları Card -->
      <div class="form-section" *ngIf="cevapAnahtari.soru_sayisi > 0">
        <div class="section-header">
          <i class="fas fa-list-ol"></i>
          <h3>Soru Detayları</h3>
          <div class="progress-info">
            {{ getCompletedAnswersCount() }}/{{ cevapAnahtari.soru_sayisi }} tamamlandı
          </div>
        </div>

        <div class="questions-container">
          <div *ngFor="let i of getSoruDizisi(cevapAnahtari); trackBy: trackByFn; let idx = index" 
                class="question-card">
            
            <div class="question-header">
              <span class="question-number">{{ i }}</span>
              <span class="question-label">. Soru</span>
            </div>
            
            <div class="question-fields">
              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-question-circle"></i>
                  Cevap
                </label>
                <select 
                  class="form-select modern-select" 
                  [(ngModel)]="cevapAnahtari.cevaplar['ca' + i]" 
                  [name]="'cevap_' + i">
                  <option value="">Seçiniz</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-bookmark"></i>
                  Konu
                </label>
                <select 
                  class="form-select modern-select" 
                  [(ngModel)]="cevapAnahtari.konular!['ka' + i]" 
                  [name]="'konu_' + i"
                  [disabled]="konularLoading">
                  <option value="">Konu seçiniz</option>
                  <optgroup *ngFor="let seviye of getSinifSeviyeleri()" [label]="seviye + '. Sınıf'">
                    <option *ngFor="let konu of getKonularByLevel(seviye)" [value]="konu.konu_adi">
                      {{ konu.konu_adi }} - {{ konu.unite_adi }}
                    </option>
                  </optgroup>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label">
                  <i class="fas fa-video"></i>
                  Video Kodu
                </label>
                <input 
                  type="text"
                  class="form-control modern-input" 
                  [(ngModel)]="cevapAnahtari.videolar!['vi' + i]" 
                  [name]="'video_' + i"
                  maxlength="20"
                  placeholder="Opsiyonel">
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Modal Footer -->
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeAddModal()">
      <i class="fas fa-times"></i>
      İptal
    </button>
    <button 
      type="submit" 
      class="btn btn-primary" 
      [disabled]="submitting || !addForm?.valid"
      (click)="onSubmit()">
      <i class="fas fa-save"></i>
      <span *ngIf="!submitting">Kaydet</span>
      <span *ngIf="submitting">
        <i class="fas fa-spinner fa-spin"></i>
        Kaydediliyor...
      </span>
    </button>
  </div>
</div>
  

  <!-- Edit Modal -->
  <div class="modal-overlay" *ngIf="showModal && isEditing && currentEditingCevapAnahtari" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="bi bi-pencil"></i>
          Cevap Anahtarını Düzenle
        </h3>
        <button class="close-btn" (click)="closeEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="updateCevapAnahtari()" #editForm="ngForm">
          <!-- Sınav Adı -->
          <div class="form-group">
            <label for="edit_sinav_adi">Sınav Adı *</label>
            <input 
              type="text" 
              id="edit_sinav_adi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_adi" 
              name="sinav_adi"
              required>
          </div>

          <!-- Sınav Türü -->
          <div class="form-group">
            <label for="edit_sinav_turu">Sınav Türü *</label>
            <select 
              id="edit_sinav_turu"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_turu" 
              name="sinav_turu"
              required>
              <option value="" disabled>Seçiniz...</option>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">{{ tur.label }}</option>
            </select>
          </div>

          <!-- Soru Sayısı -->
          <div class="form-group">
            <label for="edit_soru_sayisi">Soru Sayısı *</label>
            <input 
              type="number" 
              id="edit_soru_sayisi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.soru_sayisi" 
              name="soru_sayisi"
              min="1" 
              max="100"
              required>
          </div>

          <!-- Tarih -->
          <div class="form-group">
            <label for="edit_tarih">Tarih *</label>
            <input 
              type="date" 
              id="edit_tarih"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.tarih" 
              name="tarih"
              required>
          </div>

          <!-- Soru Detayları -->
          <div class="form-group">
            <label>Soru Detayları</label>
            <div class="basit-soru-listesi">
              <div *ngFor="let i of getSoruDizisi(currentEditingCevapAnahtari); trackBy: trackByFn" class="basit-soru-item">
                
                <div class="soru-baslik">{{ i }}. Soru</div>
                
                <!-- Cevap -->
                <div class="alan-grubu">
                  <label>Cevap:</label>
                  <select 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.cevaplar['ca' + i]" 
                    [name]="'cevap_' + i">
                    <option value="">Seçiniz</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                  </select>
                </div>

                <!-- Konu -->
                <div class="alan-grubu">
                  <label>Konu:</label>
                  <select 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.konular!['ka' + i]" 
                    [name]="'konu_' + i"
                    [disabled]="konularLoading">
                    <option value="">Konu seçiniz</option>
                    <optgroup *ngFor="let seviye of getSinifSeviyeleri()" [label]="seviye + '. Sınıf'">
                      <option *ngFor="let konu of getKonularByLevel(seviye)" [value]="konu.konu_adi">
                        {{ konu.konu_adi }} - {{ konu.unite_adi }}
                      </option>
                    </optgroup>
                  </select>
                </div>

                <!-- Video -->
                <div class="alan-grubu">
                  <label>Video:</label>
                  <input 
                    type="text" 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.videolar!['vi' + i]" 
                    [name]="'video_' + i"
                    maxlength="20"
                    placeholder="Video kodu">
                </div>

              </div>
            </div>
          </div>

          <!-- Aktiflik -->
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="currentEditingCevapAnahtari.aktiflik" 
                name="aktiflik">
              Aktif
            </label>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
              <i class="bi bi-x-circle me-1"></i>
              İptal
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="!editForm.valid">
              <i class="bi bi-check-circle me-1"></i>
              Güncelle
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>