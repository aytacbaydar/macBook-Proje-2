<div class="cevap-anahtari-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-key"></i>
        Cevap Anahtarı Yönetimi
      </h1>
      <p class="page-subtitle">Sınav cevap anahtarlarınızı oluşturun ve yönetin</p>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-content">
          <h3>{{ cevapAnahtarlari.length }}</h3>
          <p>Toplam Cevap Anahtarı</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getThisMonthCount() }}</h3>
          <p>Bu Ay Eklenen</p>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getActiveSinavCount() }}</h3>
          <p>Son Ay Aktif</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <!-- Filter Buttons -->
  <div class="filter-bar">
    <div class="filter-buttons">
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'ALL'"
        (click)="setFilter('ALL')">
        <i class="fas fa-list"></i>
        Tümü ({{ cevapAnahtarlari.length }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TYT'"
        (click)="setFilter('TYT')">
        <i class="fas fa-graduation-cap"></i>
        TYT ({{ getCountByType('TYT') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'AYT'"
        (click)="setFilter('AYT')">
        <i class="fas fa-book"></i>
        AYT ({{ getCountByType('AYT') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TAR'"
        (click)="setFilter('TAR')">
        <i class="fas fa-search"></i>
        Tarama ({{ getCountByType('TAR') }})
      </button>
      <button 
        type="button" 
        class="btn filter-btn"
        [class.active]="selectedFilter === 'TEST'"
        (click)="setFilter('TEST')">
        <i class="fas fa-clipboard-list"></i>
        Test ({{ getCountByType('TEST') }})
      </button>
    </div>
  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <div class="search-section">
      <div class="search-input-group">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          class="form-control search-input" 
          placeholder="Sınav adı ile ara..."
          [(ngModel)]="searchQuery">
      </div>
    </div>

    <button 
      type="button" 
      class="btn btn-primary add-btn"
      (click)="showAddForm = !showAddForm">
      <i class="fas fa-plus"></i>
      <span>Yeni Cevap Anahtarı</span>
    </button>
  </div>

  <!-- Add Form -->
  <div class="add-form-container" *ngIf="showAddForm">
    <div class="form-card">
      <div class="form-header">
        <h3><i class="fas fa-plus-circle"></i> Yeni Cevap Anahtarı Ekle</h3>
        <button type="button" class="close-btn" (click)="showAddForm = false">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form (ngSubmit)="onSubmit()" class="cevap-form">
        <!-- Temel Bilgiler -->
        <div class="form-row">
          <div class="form-group">
            <label for="sinav_adi">Sınav Adı *</label>
            <input 
              type="text" 
              id="sinav_adi"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.sinav_adi" 
              name="sinav_adi"
              placeholder="Örn: TYT Deneme - 1. Hafta"
              required>
          </div>

          <div class="form-group">
            <label for="sinav_turu">Sınav Türü *</label>
            <select 
              id="sinav_turu"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.sinav_turu" 
              name="sinav_turu"
              required>
              <option value="">Sınav Türü Seçiniz</option>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">{{ tur.label }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="soru_sayisi">Soru Sayısı *</label>
            <input 
              type="number" 
              id="soru_sayisi"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.soru_sayisi" 
              name="soru_sayisi"
              min="1" 
              [max]="maxSoruSayisi"
              (ngModelChange)="onSoruSayisiChange()"
              required>
          </div>

          <div class="form-group">
            <label for="tarih">Sınav Tarihi *</label>
            <input 
              type="date" 
              id="tarih"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.tarih" 
              name="tarih"
              required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="sinav_kapagi">Sınav Kapağı</label>
            <input 
              type="file" 
              id="sinav_kapagi"
              class="form-control" 
              accept="image/*"
              (change)="onFileSelected($event)">
            <small class="form-text">JPG, JPEG, PNG veya GIF formatında resim yükleyebilirsiniz.</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [(ngModel)]="cevapAnahtari.aktiflik" 
                name="aktiflik">
              <span class="checkbox-custom"></span>
              Aktif
            </label>
          </div>
        </div>

        <!-- Image Preview -->
        <div class="image-preview" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Sınav Kapağı Önizleme">
        </div>

        <!-- Soru Detayları -->
        <div class="cevaplar-section" *ngIf="cevapAnahtari.soru_sayisi > 0">
          <h4><i class="fas fa-list-ol"></i> Soru Detayları</h4>

          <div class="basit-soru-listesi">
            <div *ngFor="let i of getSoruDizisi(cevapAnahtari); trackBy: trackByFn" class="basit-soru-item">
              
              <div class="soru-baslik">{{ i }}. Soru</div>
              
              <!-- Cevap -->
              <div class="alan-grubu">
                <label>Cevap:</label>
                <select 
                  class="basit-input"
                  [(ngModel)]="cevapAnahtari.cevaplar['ca' + i]" 
                  [name]="'cevap_' + i">
                  <option value="">Seçiniz</option>
                  <option value="A">A</option>
                  <option value="B">B</option>
                  <option value="C">C</option>
                  <option value="D">D</option>
                  <option value="E">E</option>
                </select>
              </div>

              <!-- Konu -->
              <div class="alan-grubu">
                <label>Konu:</label>
                <select 
                  class="basit-input"
                  [(ngModel)]="cevapAnahtari.konular!['ka' + i]" 
                  [name]="'konu_' + i"
                  [disabled]="konularLoading">
                  <option value="">Konu seçiniz</option>
                  <optgroup *ngFor="let seviye of getSinifSeviyeleri()" [label]="seviye + '. Sınıf'">
                    <option *ngFor="let konu of getKonularByLevel(seviye)" [value]="konu.konu_adi">
                      {{ konu.konu_adi }} - {{ konu.unite_adi }}
                    </option>
                  </optgroup>
                </select>
              </div>

              <!-- Video -->
              <div class="alan-grubu">
                <label>Video:</label>
                <input 
                  type="text" 
                  class="basit-input"
                  [(ngModel)]="cevapAnahtari.videolar!['vi' + i]" 
                  [name]="'video_' + i"
                  maxlength="20"
                  placeholder="Video kodu">
              </div>

            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="showAddForm = false">
            İptal
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="submitting">
            <i class="fas fa-save"></i>
            <span *ngIf="!submitting">Kaydet</span>
            <span *ngIf="submitting">Kaydediliyor...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cevap Anahtarları Listesi -->
  <div *ngIf="!loading && filteredCevapAnahtarlari.length > 0" class="answer-keys-grid">
    <div *ngFor="let cevapAnahtari of filteredCevapAnahtarlari" class="answer-key-card">
      <div class="card-header">
        <h3>{{ cevapAnahtari.sinav_adi }}</h3>
        <span class="date-badge">{{ formatDate(cevapAnahtari.olusturma_tarihi) }}</span>
      </div>

      <div class="card-body">
        <div class="exam-info">
          <div class="info-item">
            <i class="bi bi-calendar-event"></i>
            <span>{{ formatDate(cevapAnahtari.sinav_tarihi) }}</span>
          </div>
          <div class="info-item">
            <i class="bi bi-clock"></i>
            <span>{{ cevapAnahtari.sinav_suresi }} dk</span>
          </div>
          <div class="info-item">
            <i class="bi bi-list-ol"></i>
            <span>{{ getSoruSayisi(cevapAnahtari.cevaplar) }} Soru</span>
          </div>
        </div>

        <div class="answer-preview">
          <h4>Cevap Anahtarı</h4>
          <div class="answers-row">
            <div *ngFor="let cevap of getAnswersArray(cevapAnahtari.cevaplar); let i = index" class="answer-item">
              <span class="question-number">{{ cevap.index }}</span>
              <span class="answer-letter">{{ cevap.value || '-' }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="card-actions">
        <button class="btn btn-outline-primary btn-sm" (click)="viewAnswerKey(cevapAnahtari)">
          <i class="bi bi-eye"></i>
          Görüntüle
        </button>
        <button class="btn btn-outline-warning btn-sm" (click)="editAnswerKey(cevapAnahtari)">
          <i class="bi bi-pencil"></i>
          Düzenle
        </button>
        <button class="btn btn-outline-danger btn-sm" (click)="deleteAnswerKey(cevapAnahtari.id)">
          <i class="bi bi-trash"></i>
          Sil
        </button>
      </div>
    </div>
  </div>

    <div *ngIf="!loading && filteredCevapAnahtarlari.length === 0" class="empty-state">
      <i class="fas fa-search"></i>
      <h3 *ngIf="selectedFilter === 'ALL' && !searchQuery">Henüz cevap anahtarı bulunmuyor</h3>
      <h3 *ngIf="selectedFilter !== 'ALL' || searchQuery">{{ getEmptyStateMessage() }}</h3>
      <p *ngIf="selectedFilter === 'ALL' && !searchQuery">İlk cevap anahtarınızı oluşturmak için yukarıdaki butonu kullanın.</p>
      <p *ngIf="selectedFilter !== 'ALL' || searchQuery">Farklı kriterlerle tekrar arayabilir veya yeni cevap anahtarı ekleyebilirsiniz.</p>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" *ngIf="showModal && isEditing && currentEditingCevapAnahtari" (click)="closeEditModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>
          <i class="bi bi-pencil"></i>
          Cevap Anahtarını Düzenle
        </h3>
        <button class="close-btn" (click)="closeEditModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="updateCevapAnahtari()" #editForm="ngForm">
          <!-- Sınav Adı -->
          <div class="form-group">
            <label for="edit_sinav_adi">Sınav Adı *</label>
            <input 
              type="text" 
              id="edit_sinav_adi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_adi" 
              name="sinav_adi"
              required>
          </div>

          <!-- Sınav Türü -->
          <div class="form-group">
            <label for="edit_sinav_turu">Sınav Türü *</label>
            <select 
              id="edit_sinav_turu"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_turu" 
              name="sinav_turu"
              required>
              <option value="" disabled>Seçiniz...</option>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">{{ tur.label }}</option>
            </select>
          </div>

          <!-- Soru Sayısı -->
          <div class="form-group">
            <label for="edit_soru_sayisi">Soru Sayısı *</label>
            <input 
              type="number" 
              id="edit_soru_sayisi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.soru_sayisi" 
              name="soru_sayisi"
              min="1" 
              max="100"
              required>
          </div>

          <!-- Tarih -->
          <div class="form-group">
            <label for="edit_tarih">Tarih *</label>
            <input 
              type="date" 
              id="edit_tarih"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.tarih" 
              name="tarih"
              required>
          </div>

          <!-- Soru Detayları -->
          <div class="form-group">
            <label>Soru Detayları</label>
            <div class="basit-soru-listesi">
              <div *ngFor="let i of getSoruDizisi(currentEditingCevapAnahtari); trackBy: trackByFn" class="basit-soru-item">
                
                <div class="soru-baslik">{{ i }}. Soru</div>
                
                <!-- Cevap -->
                <div class="alan-grubu">
                  <label>Cevap:</label>
                  <select 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.cevaplar['ca' + i]" 
                    [name]="'cevap_' + i">
                    <option value="">Seçiniz</option>
                    <option value="A">A</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="E">E</option>
                  </select>
                </div>

                <!-- Konu -->
                <div class="alan-grubu">
                  <label>Konu:</label>
                  <select 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.konular!['ka' + i]" 
                    [name]="'konu_' + i"
                    [disabled]="konularLoading">
                    <option value="">Konu seçiniz</option>
                    <optgroup *ngFor="let seviye of getSinifSeviyeleri()" [label]="seviye + '. Sınıf'">
                      <option *ngFor="let konu of getKonularByLevel(seviye)" [value]="konu.konu_adi">
                        {{ konu.konu_adi }} - {{ konu.unite_adi }}
                      </option>
                    </optgroup>
                  </select>
                </div>

                <!-- Video -->
                <div class="alan-grubu">
                  <label>Video:</label>
                  <input 
                    type="text" 
                    class="basit-input"
                    [(ngModel)]="currentEditingCevapAnahtari.videolar!['vi' + i]" 
                    [name]="'video_' + i"
                    maxlength="20"
                    placeholder="Video kodu">
                </div>

              </div>
            </div>
          </div>

          <!-- Aktiflik -->
          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="currentEditingCevapAnahtari.aktiflik" 
                name="aktiflik">
              Aktif
            </label>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
              <i class="bi bi-x-circle me-1"></i>
              İptal
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="!editForm.valid">
              <i class="bi bi-check-circle me-1"></i>
              Güncelle
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>