
<div class="cevap-anahtari-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-key"></i>
        Cevap Anahtarı Yönetimi
      </h1>
      <p class="page-subtitle">Sınav cevap anahtarlarınızı oluşturun ve yönetin</p>
    </div>

    <!-- Quick Stats -->
    <div class="quick-stats">
      <div class="stat-card">
        <div class="stat-icon primary">
          <i class="fas fa-clipboard-list"></i>
        </div>
        <div class="stat-content">
          <h3>{{ cevapAnahtarlari.length }}</h3>
          <p>Toplam Cevap Anahtarı</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon success">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getThisMonthCount() }}</h3>
          <p>Bu Ay Eklenen</p>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon warning">
          <i class="fas fa-chart-line"></i>
        </div>
        <div class="stat-content">
          <h3>{{ getActiveSinavCount() }}</h3>
          <p>Son Ay Aktif</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    <i class="fas fa-check-circle"></i>
    {{ successMessage }}
  </div>

  <div *ngIf="errorMessage" class="alert alert-danger">
    <i class="fas fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <!-- Action Bar -->
  <div class="action-bar">
    <div class="search-section">
      <div class="search-input-group">
        <i class="fas fa-search search-icon"></i>
        <input 
          type="text" 
          class="form-control search-input" 
          placeholder="Sınav adı veya türü ile ara..."
          [(ngModel)]="searchQuery">
      </div>
    </div>
    
    <button 
      type="button" 
      class="btn btn-primary add-btn"
      (click)="showAddForm = !showAddForm">
      <i class="fas fa-plus"></i>
      <span>Yeni Cevap Anahtarı</span>
    </button>
  </div>

  <!-- Add Form -->
  <div class="add-form-container" *ngIf="showAddForm">
    <div class="form-card">
      <div class="form-header">
        <h3><i class="fas fa-plus-circle"></i> Yeni Cevap Anahtarı Ekle</h3>
        <button type="button" class="close-btn" (click)="showAddForm = false">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <form (ngSubmit)="onSubmit()" class="cevap-form">
        <!-- Temel Bilgiler -->
        <div class="form-row">
          <div class="form-group">
            <label for="sinav_adi">Sınav Adı *</label>
            <input 
              type="text" 
              id="sinav_adi"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.sinav_adi" 
              name="sinav_adi"
              placeholder="Örn: TYT Deneme - 1. Hafta"
              required>
          </div>

          <div class="form-group">
            <label for="sinav_turu">Sınav Türü *</label>
            <select 
              id="sinav_turu"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.sinav_turu" 
              name="sinav_turu"
              required>
              <option value="">Sınav Türü Seçiniz</option>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">{{ tur.label }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="soru_sayisi">Soru Sayısı *</label>
            <input 
              type="number" 
              id="soru_sayisi"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.soru_sayisi" 
              name="soru_sayisi"
              min="1" 
              [max]="maxSoruSayisi"
              (ngModelChange)="onSoruSayisiChange()"
              required>
          </div>

          <div class="form-group">
            <label for="tarih">Sınav Tarihi *</label>
            <input 
              type="date" 
              id="tarih"
              class="form-control" 
              [(ngModel)]="cevapAnahtari.tarih" 
              name="tarih"
              required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="sinav_kapagi">Sınav Kapağı</label>
            <input 
              type="file" 
              id="sinav_kapagi"
              class="form-control" 
              accept="image/*"
              (change)="onFileSelected($event)">
            <small class="form-text">JPG, JPEG, PNG veya GIF formatında resim yükleyebilirsiniz.</small>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                [(ngModel)]="cevapAnahtari.aktiflik" 
                name="aktiflik">
              <span class="checkbox-custom"></span>
              Aktif
            </label>
          </div>
        </div>

        <!-- Image Preview -->
        <div class="image-preview" *ngIf="imagePreview">
          <img [src]="imagePreview" alt="Sınav Kapağı Önizleme">
        </div>

        <!-- Cevaplar -->
        <div class="cevaplar-section" *ngIf="cevapAnahtari.soru_sayisi > 0">
          <h4><i class="fas fa-list-ol"></i> Cevaplar</h4>
          
          <div class="cevaplar-grid">
            <div *ngFor="let soruNo of getSoruDizisi(cevapAnahtari); trackBy: trackByFn" 
                 class="cevap-item">
              <label class="cevap-label">{{ soruNo }}</label>
              <select 
                class="form-control cevap-select" 
                [(ngModel)]="cevapAnahtari.cevaplar['ca' + soruNo]" 
                [name]="'cevap_' + soruNo">
                <option value="">-</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="showAddForm = false">
            İptal
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="submitting">
            <i class="fas fa-save"></i>
            <span *ngIf="!submitting">Kaydet</span>
            <span *ngIf="submitting">Kaydediliyor...</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Cevap Anahtarları Listesi -->
  <div class="list-container">
    <div *ngIf="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Cevap anahtarları yükleniyor...</p>
    </div>

    <div *ngIf="!loading && filteredCevapAnahtarlari.length === 0" class="empty-state">
      <i class="fas fa-clipboard-list"></i>
      <h3>Henüz Cevap Anahtarı Bulunmuyor</h3>
      <p>İlk cevap anahtarınızı oluşturmak için yukarıdaki "Yeni Cevap Anahtarı" butonunu kullanın.</p>
    </div>

    <div *ngIf="!loading && filteredCevapAnahtarlari.length > 0" class="cevap-anahtarlari-grid">
      <div *ngFor="let cevap of filteredCevapAnahtarlari; trackBy: trackByFn" 
           class="cevap-card" 
           [class.inactive]="!cevap.aktiflik">
        
        <div class="card-header">
          <div class="title-section">
            <h3 class="card-title">{{ cevap.sinav_adi }}</h3>
            <span class="sinav-turu-badge" [attr.data-type]="cevap.sinav_turu">
              {{ getSinavTuruLabel(cevap.sinav_turu) }}
            </span>
          </div>
          
          <div class="card-actions">
            <button type="button" 
                    class="btn-icon edit-btn" 
                    (click)="editCevapAnahtari(cevap)" 
                    title="Düzenle">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" 
                    class="btn-icon delete-btn" 
                    (click)="deleteCevapAnahtari(cevap.id!)" 
                    title="Sil">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="info-grid">
            <div class="info-item">
              <i class="fas fa-calendar"></i>
              <span>{{ cevap.tarih | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="info-item">
              <i class="fas fa-question-circle"></i>
              <span>{{ cevap.soru_sayisi }} Soru</span>
            </div>
            <div class="info-item">
              <i class="fas fa-toggle-on" *ngIf="cevap.aktiflik"></i>
              <i class="fas fa-toggle-off" *ngIf="!cevap.aktiflik"></i>
              <span>{{ cevap.aktiflik ? 'Aktif' : 'Pasif' }}</span>
            </div>
          </div>

          <!-- Sınav Kapağı -->
          <div *ngIf="cevap.sinav_kapagi" class="sinav-kapagi">
            <img [src]="'./server/uploads/' + cevap.sinav_kapagi" 
                 [alt]="cevap.sinav_adi"
                 class="kapak-resmi">
          </div>

          <!-- Cevap Özeti -->
          <div class="cevap-ozeti">
            <h5><i class="fas fa-list"></i> Cevap Özeti</h5>
            <div class="cevap-preview">
              <div *ngFor="let soruNo of getSoruDizisi(cevap).slice(0, 20); trackBy: trackByFn" 
                   class="cevap-mini">
                <span class="soru-no">{{ soruNo }}</span>
                <span class="cevap-harfi" 
                      [class.empty]="!cevap.cevaplar['ca' + soruNo]">
                  {{ cevap.cevaplar['ca' + soruNo] || '-' }}
                </span>
              </div>
              <span *ngIf="getSoruDizisi(cevap).length > 20" class="more-indicator">
                +{{ getSoruDizisi(cevap).length - 20 }} soru daha...
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal-overlay" *ngIf="showModal && currentEditingCevapAnahtari" (click)="closeEditModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3><i class="fas fa-edit"></i> Cevap Anahtarını Düzenle</h3>
      <button type="button" class="close-btn" (click)="closeEditModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <form (ngSubmit)="updateCevapAnahtari()">
        <!-- Temel Bilgiler -->
        <div class="form-row">
          <div class="form-group">
            <label for="edit_sinav_adi">Sınav Adı *</label>
            <input 
              type="text" 
              id="edit_sinav_adi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_adi" 
              name="edit_sinav_adi"
              required>
          </div>

          <div class="form-group">
            <label for="edit_sinav_turu">Sınav Türü *</label>
            <select 
              id="edit_sinav_turu"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.sinav_turu" 
              name="edit_sinav_turu"
              required>
              <option *ngFor="let tur of sinavTurleri" [value]="tur.id">{{ tur.label }}</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="edit_soru_sayisi">Soru Sayısı *</label>
            <input 
              type="number" 
              id="edit_soru_sayisi"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.soru_sayisi" 
              name="edit_soru_sayisi"
              min="1" 
              [max]="maxSoruSayisi"
              required>
          </div>

          <div class="form-group">
            <label for="edit_tarih">Sınav Tarihi *</label>
            <input 
              type="date" 
              id="edit_tarih"
              class="form-control" 
              [(ngModel)]="currentEditingCevapAnahtari.tarih" 
              name="edit_tarih"
              required>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              [(ngModel)]="currentEditingCevapAnahtari.aktiflik" 
              name="edit_aktiflik">
            <span class="checkbox-custom"></span>
            Aktif
          </label>
        </div>

        <!-- Cevaplar -->
        <div class="cevaplar-section">
          <h4><i class="fas fa-list-ol"></i> Cevaplar</h4>
          
          <div class="cevaplar-grid">
            <div *ngFor="let soruNo of getSoruDizisi(currentEditingCevapAnahtari); trackBy: trackByFn" 
                 class="cevap-item">
              <label class="cevap-label">{{ soruNo }}</label>
              <select 
                class="form-control cevap-select" 
                [(ngModel)]="currentEditingCevapAnahtari.cevaplar['ca' + soruNo]" 
                [name]="'edit_cevap_' + soruNo">
                <option value="">-</option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
                <option value="E">E</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
            İptal
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            Güncelle
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
