<div class="exam-results-container">
  <!-- Header -->
  <div class="results-header">
    <h2 class="section-title">
      <i class="bi bi-graph-up me-2"></i>
      Sınav Sonuçları
    </h2>
    <p class="section-description">Öğrencilerin sınav performanslarını görüntüleyin</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Sınav sonuçları yükleniyor...</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-container">
    <div class="error-card">
      <i class="bi bi-exclamation-triangle-fill error-icon"></i>
      <h3>Hata Oluştu</h3>
      <p>{{ error }}</p>
      <button class="retry-button" (click)="loadSinavSonuclari()">
        <i class="bi bi-arrow-clockwise me-1"></i>
        Tekrar Dene
      </button>
    </div>
  </div>

  <!-- Exams List -->
  <div *ngIf="!loading && !error && sinavlar.length > 0" class="exams-grid">
    <div 
      class="exam-card" 
      *ngFor="let sinav of sinavlar; trackBy: trackBySinavId"
      (click)="selectSinav(sinav)"
      [class.selected]="selectedSinav?.id === sinav.id">

      <!-- Exam Header -->
      <div class="exam-header" [style.background]="getExamTypeColor(sinav.sinav_turu)">
        <div class="exam-type-badge">
          <i class="{{ getExamTypeIcon(sinav.sinav_turu) }}"></i>
          {{ getExamTypeLabel(sinav.sinav_turu) }}
        </div>
        <div class="exam-date">
          <i class="bi bi-calendar3"></i>
          {{ formatDate(sinav.tarih) }}
        </div>
      </div>

      <!-- Exam Info -->
      <div class="exam-info">
        <h3 class="exam-title">{{ sinav.sinav_adi }}</h3>
        <div class="exam-stats">
          <div class="stat-item">
            <i class="bi bi-people"></i>
            <span>{{ sinav.katilimci_sayisi || 0 }} Katılımcı</span>
          </div>
          <div class="stat-item">
            <i class="bi bi-list-ol"></i>
            <span>{{ sinav.soru_sayisi }} Soru</span>
          </div>
        </div>
      </div>

      <!-- Selection Indicator -->
      <div class="selection-indicator" *ngIf="selectedSinav?.id === sinav.id">
        <i class="bi bi-check-circle-fill"></i>
      </div>
    </div>
  </div>

  <!-- No Exams State -->
  <div *ngIf="!loading && !error && sinavlar.length === 0" class="empty-state">
    <div class="empty-card">
      <i class="bi bi-file-earmark-text empty-icon"></i>
      <h3>Henüz Sınav Bulunamadı</h3>
      <p>Sınav sonuçlarını görüntülemek için önce cevap anahtarı oluşturun.</p>
    </div>
  </div>

  <!-- Selected Exam Results -->
  <div *ngIf="selectedSinav && studentResults.length > 0" class="results-section">
    <div class="results-header-section">
      <h3 class="results-title">
        {{ selectedSinav.sinav_adi }} - Sonuçlar
      </h3>
      <div class="results-summary">
        <div class="summary-item">
          <span class="label">Toplam Katılımcı:</span>
          <span class="value">{{ studentResults.length }}</span>
        </div>
        <div class="summary-item">
          <span class="label">Ortalama Net:</span>
          <span class="value">{{ calculateAverageNet() | number:'1.2-2' }}</span>
        </div>
        <div class="summary-item">
          <span class="label">En Yüksek Net:</span>
          <span class="value">{{ getHighestNet() | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <div class="results-table-container">
      <table class="results-table">
        <thead>
          <tr>
            <th>Sıra</th>
            <th>Öğrenci Adı</th>
            <th class="text-center">Doğru</th>
            <th class="text-center">Yanlış</th>
            <th class="text-center">Boş</th>
            <th class="text-center">Net</th>
            <th class="text-center">Puan</th>
            <th class="text-center">Yüzde</th>
            <th class="text-center">Tarih</th>
            <th class="text-center">İşlemler</th>
          </tr>
        </thead>
        <tbody>
          <tr 
            *ngFor="let result of studentResults; let i = index; trackBy: trackByStudentResult"
            [class.top-performer]="i < 3">
            <td class="rank-cell">
              <div class="rank-badge" [class]="getRankClass(i)">
                <span *ngIf="i < 3" class="rank-icon">
                  <i class="bi bi-trophy-fill" *ngIf="i === 0"></i>
                  <i class="bi bi-award-fill" *ngIf="i === 1"></i>
                  <i class="bi bi-award" *ngIf="i === 2"></i>
                </span>
                <span class="rank-number">{{ i + 1 }}</span>
              </div>
            </td>
            <td class="student-cell">
              <div class="student-info">
                <strong>{{ result.ogrenci_adi }}</strong>
                <small class="text-muted">ID: {{ result.ogrenci_id }}</small>
              </div>
            </td>
            <td class="text-center">
              <span class="stat-badge success">{{ result.dogru_sayisi }}</span>
            </td>
            <td class="text-center">
              <span class="stat-badge danger">{{ result.yanlis_sayisi }}</span>
            </td>
            <td class="text-center">
              <span class="stat-badge warning">{{ result.bos_sayisi }}</span>
            </td>
            <td class="text-center">
              <span class="stat-badge info">{{ result.net_sayisi | number:'1.2-2' }}</span>
            </td>
            <td class="text-center">
              <span class="score-badge">{{ result.puan | number:'1.2-2' }}</span>
            </td>
            <td class="text-center">
              <div class="percentage-container">
                <span class="percentage-text">{{ result.yuzde | number:'1.2-2' }}%</span>
                <div class="percentage-bar">
                  <div 
                    class="percentage-fill" 
                    [style.width.%]="result.yuzde"
                    [style.background]="getPercentageColor(result.yuzde)">
                  </div>
                </div>
              </div>
            </td>
            <td class="text-center text-muted">
              <small>{{ formatDateTime(result.gonderim_tarihi) }}</small>
            </td>
            <td class="text-center">
              <button 
                class="btn btn-sm btn-outline-primary me-1" 
                (click)="showStudentDetail(result)"
                title="Detay Görüntüle">
                <i class="bi bi-eye"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- No Results for Selected Exam -->
  <div *ngIf="selectedSinav && studentResults.length === 0 && !loadingResults" class="no-results">
    <div class="no-results-card">
      <i class="bi bi-graph-down no-results-icon"></i>
      <h3>Bu Sınav İçin Sonuç Bulunamadı</h3>
      <p>{{ selectedSinav.sinav_adi }} sınavına henüz öğrenci katılmamış veya sonuçlar hesaplanmamış.</p>
    </div>
  </div>

  <!-- Loading Results -->
  <div *ngIf="loadingResults" class="loading-results">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p>Sınav sonuçları yükleniyor...</p>
    </div>
  </div>
</div>
<!-- Öğrenci Sınav Detayı Modal -->
<div class="modal fade" [class.show]="showStudentDetailModal" [style.display]="showStudentDetailModal ? 'block' : 'none'" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-person-lines-fill me-2"></i>
          {{ selectedStudentResult?.ogrenci_adi || selectedStudentDetail?.ogrenci_adi }} - Sınav Detayı
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeStudentDetailModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedStudentDetail" class="student-exam-detail">
          <!-- Özet Bilgiler -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="stat-card bg-success text-white">
                <div class="stat-icon">
                  <i class="bi bi-check-circle-fill"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ selectedStudentDetail.dogru_sayisi }}</h3>
                  <p>Doğru</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-danger text-white">
                <div class="stat-icon">
                  <i class="bi bi-x-circle-fill"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ selectedStudentDetail.yanlis_sayisi }}</h3>
                  <p>Yanlış</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-warning text-white">
                <div class="stat-icon">
                  <i class="bi bi-dash-circle-fill"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ selectedStudentDetail.bos_sayisi }}</h3>
                  <p>Boş</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-card bg-info text-white">
                <div class="stat-icon">
                  <i class="bi bi-calculator"></i>
                </div>
                <div class="stat-content">
                  <h3>{{ calculateNet(selectedStudentDetail) }}</h3>
                  <p>Net</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Soru Detayları -->
          <div class="question-details" *ngIf="studentQuestionDetails && studentQuestionDetails.length > 0">
            <h6 class="fw-bold mb-3">Soru Bazında Analiz:</h6>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>Soru No</th>
                    <th>Öğrenci Cevabı</th>
                    <th>Doğru Cevap</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let soru of studentQuestionDetails" [class]="getQuestionRowClass(soru)">
                    <td class="fw-bold">{{ getQuestionNumber(soru.soru_no) }}</td>
                    <td>
                      <span class="badge fs-6" [class]="getAnswerBadgeClass(soru.ogrenci_cevabi)">
                        {{ soru.ogrenci_cevabi || 'BOŞ' }}
                      </span>
                    </td>
                    <td>
                      <span class="badge bg-success fs-6">{{ soru.dogru_cevap }}</span>
                    </td>
                    <td>
                      <span class="badge fs-6" [class]="getStatusBadgeClass(soru)">
                        <i [class]="getStatusIcon(soru)" class="me-1"></i>
                        {{ getStatusText(soru) }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <div *ngIf="(!studentQuestionDetails || studentQuestionDetails.length === 0) && !loadingStudentDetail" class="text-center py-4">
            <div class="empty-state">
              <i class="bi bi-question-circle text-muted" style="font-size: 3rem;"></i>
              <h5 class="text-muted mt-3">Soru detayları yüklenemedi</h5>
              <p class="text-muted">Bu sınava ait soru detayları bulunamadı.</p>
            </div>
          </div>

          <div *ngIf="loadingStudentDetail" class="text-center p-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Yükleniyor...</span>
            </div>
            <p class="mt-2 mb-0">Soru detayları yükleniyor...</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeStudentDetailModal()">
          <i class="bi bi-x-lg me-1"></i>
          Kapat
        </button>
      </div>
    </div>
  </div>
</div>