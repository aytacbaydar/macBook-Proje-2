
<div class="modern-page-container">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-text">
        <h1 class="page-title">
          <i class="bi bi-check2-square me-2"></i>
          İşlenen Konular
        </h1>
        <p class="page-description">
          Hangi gruplarınızla hangi konuları işlediğinizi takip edin
        </p>
      </div>
      <div class="header-actions">
        <button class="modern-btn modern-btn-primary" (click)="openKonuModal()">
          <i class="bi bi-plus-circle"></i>
          Konu Ekle
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Yükleniyor...</span>
    </div>
    <p class="mt-2 text-muted">Veriler yükleniyor...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
    <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadKonular()">
      Tekrar Dene
    </button>
  </div>

  <!-- Main Content - Gruplar -->
  <div *ngIf="!isLoading && !error" class="content-wrapper">
    <!-- Gruplar Grid -->
    <div class="groups-grid">
      <div class="group-card" 
           *ngFor="let group of groups" 
           (click)="selectGroup(group.name)"
           [class.selected]="selectedGrup === group.name">
        
        <!-- Group Header -->
        <div class="group-header" [style.background-color]="group.color">
          <div class="group-title">
            <i class="bi bi-people-fill me-2"></i>
            {{ group.name }}
          </div>
          <div class="group-stats">
            <span class="student-count">{{ group.students.length }} öğrenci</span>
          </div>
        </div>

        <!-- Group Body -->
        <div class="group-body">
          <div class="konu-progress">
            <div class="progress-info">
              <span class="progress-text">İşlenen Konular</span>
              <span class="progress-count">{{ getToplamIslenenKonu(group.name) }} / {{ konular.length }}</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" 
                   [style.width.%]="konular.length > 0 ? (getToplamIslenenKonu(group.name) / konular.length) * 100 : 0"
                   [style.background-color]="group.color">
              </div>
            </div>
            <div class="progress-percentage">
              %{{ konular.length > 0 ? ((getToplamIslenenKonu(group.name) / konular.length) * 100).toFixed(0) : 0 }}
            </div>
          </div>

          <!-- Son İşlenen Konular -->
          <div class="last-topics" *ngIf="getIslenenKonularByGrup(group.name).length > 0">
            <h6>Son İşlenen:</h6>
            <div class="topic-list">
              <div class="topic-item" *ngFor="let islenen of getIslenenKonularByGrup(group.name).slice(0, 2)">
                <i class="bi bi-check-circle-fill text-success me-1"></i>
                <span>{{ islenen.konu_baslik }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Seçilen Grup Detayları -->
    <div *ngIf="selectedGrup" class="selected-group-details">
      <div class="group-detail-header">
        <h3>
          <i class="bi bi-people-fill me-2"></i>
          {{ selectedGrup }} - Konu Detayları
        </h3>
        <button class="close-detail-btn" (click)="selectedGrup = ''">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <!-- Sınıf Seviyelerine Göre Konular -->
      <div class="sinif-seviyeleri-container">
        <div class="sinif-seviyesi-card" *ngFor="let seviye of sinifSeviyeleri">
          <div class="card-header">
            <h4>
              <i class="bi bi-book"></i>
              {{ seviye.label }}
            </h4>
            <div class="konu-sayisi">
              {{ getKonularBySinif(seviye.value).length }} Konu
            </div>
          </div>

          <div class="card-body">
            <div *ngIf="getKonularBySinif(seviye.value).length === 0" class="empty-state">
              <i class="bi bi-journal-x fs-1 text-muted"></i>
              <p class="text-muted">Bu seviye için henüz konu eklenmemiş</p>
            </div>

            <div class="uniteler-container" *ngIf="getKonularBySinif(seviye.value).length > 0">
              <div class="unite-group" *ngFor="let unite of getUnitesBySinif(seviye.value)">
                <div class="unite-header">
                  <h4 class="unite-title">
                    <i class="bi bi-book"></i>
                    {{ unite.unite_adi }}
                  </h4>
                  <span class="konu-count">{{ unite.konular.length }} konu</span>
                </div>
                
                <div class="konular-list">
                  <div class="konu-item" *ngFor="let konu of unite.konular">
                    <div class="konu-content">
                      <div class="konu-info">
                        <h6 class="konu-adi">{{ konu.konu_adi }}</h6>
                        <p class="konu-aciklama" *ngIf="konu.aciklama">{{ konu.aciklama }}</p>
                      </div>
                      
                      <div class="konu-actions">
                        <button 
                          class="tik-btn"
                          [class.completed]="konuIslendi(konu.id!, selectedGrup)"
                          (click)="toggleKonuDurumu(konu, selectedGrup)"
                          [title]="konuIslendi(konu.id!, selectedGrup) ? 'İşlenmemiş olarak işaretle' : 'İşlenmiş olarak işaretle'">
                          <i class="bi" 
                             [class.bi-check-circle-fill]="konuIslendi(konu.id!, selectedGrup)" 
                             [class.bi-circle]="!konuIslendi(konu.id!, selectedGrup)"></i>
                        </button>
                      </div>
                    </div>

                    <div class="konu-status" *ngIf="konuIslendi(konu.id!, selectedGrup)">
                      <small class="text-success">
                        <i class="bi bi-check-circle me-1"></i>
                        İşlenmiş
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grup Seçilmediğinde Gösterilecek Mesaj -->
    <div *ngIf="!selectedGrup && groups.length > 0" class="no-group-selected">
      <div class="selection-prompt">
        <i class="bi bi-hand-index fs-1 text-muted"></i>
        <h4>Grup Seçin</h4>
        <p class="text-muted">Konuları görüntülemek ve işlemek için yukarıdan bir grup seçin</p>
      </div>
    </div>

    <!-- Hiç Grup Yoksa -->
    <div *ngIf="groups.length === 0" class="empty-state">
      <i class="bi bi-people fs-1 text-muted"></i>
      <h4>Henüz Grup Bulunmuyor</h4>
      <p class="text-muted">Henüz hiç öğrenci grubunuz yok. Öğrenciler otomatik olarak gruplarına göre burada görünecektir.</p>
    </div>
  </div>

  <!-- Konu Ekleme Modalı -->
  <div class="modern-modal-overlay" *ngIf="showKonuModal" (click)="closeKonuModal()">
    <div class="modern-modal-content" (click)="$event.stopPropagation()">
      <div class="modern-modal-header">
        <div class="modal-title-section">
          <div class="modal-icon">
            <i class="bi bi-plus-circle"></i>
          </div>
          <div class="modal-title-text">
            <h4>Yeni Konu Ekle</h4>
            <p>Müfredata yeni bir konu ekleyin</p>
          </div>
        </div>
        <button type="button" class="modern-close-btn" (click)="closeKonuModal()">
          <i class="bi bi-x"></i>
        </button>
      </div>

      <div class="modern-modal-body">
        <form class="modern-form">
          <div class="form-group">
            <label class="modern-label">
              <i class="bi bi-book"></i>
              Ünite Adı
            </label>
            <input type="text" 
                   class="modern-input" 
                   [(ngModel)]="konuForm.unite_adi" 
                   name="unite_adi" 
                   placeholder="Örn: Atom ve Periyodik Sistem"
                   required>
          </div>

          <div class="form-group">
            <label class="modern-label">
              <i class="bi bi-journal-text"></i>
              Konu Adı
            </label>
            <input type="text" 
                   class="modern-input" 
                   [(ngModel)]="konuForm.konu_adi" 
                   name="konu_adi" 
                   placeholder="Örn: Atom Yapısı ve Elektronik Dağılım"
                   required>
          </div>

          <div class="form-group">
            <label class="modern-label">
              <i class="bi bi-mortarboard"></i>
              Sınıf Seviyesi
            </label>
            <select class="modern-select" [(ngModel)]="konuForm.sinif_seviyesi" name="sinif_seviyesi">
              <option *ngFor="let seviye of sinifSeviyeleri" [value]="seviye.value">
                {{ seviye.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="modern-label">
              <i class="bi bi-card-text"></i>
              Açıklama (Opsiyonel)
            </label>
            <textarea class="modern-textarea" 
                      [(ngModel)]="konuForm.aciklama" 
                      name="aciklama" 
                      rows="3"
                      placeholder="Konu hakkında kısa açıklama yazabilirsiniz..."></textarea>
          </div>
        </form>

        <div *ngIf="error" class="alert alert-danger mt-3">
          {{ error }}
        </div>
      </div>

      <div class="modern-modal-footer">
        <button type="button" class="modern-btn modern-btn-secondary" (click)="closeKonuModal()">
          <i class="bi bi-x-circle"></i>
          İptal
        </button>
        <button type="button" 
                class="modern-btn modern-btn-primary" 
                (click)="submitKonu()"
                [disabled]="isLoading || !konuForm.unite_adi.trim() || !konuForm.konu_adi.trim()">
          <i class="bi bi-check-circle"></i>
          {{ isLoading ? 'Kaydediliyor...' : 'Konu Ekle' }}
        </button>
      </div>
    </div>
  </div>
</div>
