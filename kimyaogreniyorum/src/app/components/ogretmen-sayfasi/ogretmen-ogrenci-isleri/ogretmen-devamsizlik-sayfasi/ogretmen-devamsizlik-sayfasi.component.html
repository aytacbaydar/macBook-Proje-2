<div class="modern-attendance-container">
  <!-- Modern Header -->
  <div class="modern-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="page-title">
          <i class="bi bi-calendar-check"></i>
          Devamsızlık Takibi
        </h1>
        <p class="page-subtitle">Öğrenci devamsızlığını manuel veya QR kod ile takip edin</p>
      </div>

      <!-- Quick Stats -->
      <div class="quick-stats">
        <div class="stat-item">
          <div class="stat-value">{{ totalStudents }}</div>
          <div class="stat-label">Toplam Öğrenci</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ presentStudents }}</div>
          <div class="stat-label">Katılanlar</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ absentStudents }}</div>
          <div class="stat-label">Katılmayanlar</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">{{ getAttendancePercentage() }}%</div>
          <div class="stat-label">Katılım Oranı</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls Section -->
  <div class="controls-card">
    <div class="card-header">
      <h3><i class="bi bi-gear"></i> Kontroller</h3>
    </div>
    <div class="card-body">
      <div class="controls-grid">
        <div class="control-item">
          <label>Grup Seçin</label>
          <select class="modern-select" [(ngModel)]="selectedGroup" (change)="onGroupChange()">
            <option value="">Grup seçiniz...</option>
            <option *ngFor="let group of groups" [value]="group.name">{{ group.name }}</option>
          </select>
        </div>

        <div class="control-item">
          <label>Tarih</label>
          <input type="date" class="modern-input" [(ngModel)]="selectedDate" (change)="loadAttendanceData()">
        </div>

        <div class="control-item">
          <button class="btn btn-primary" (click)="toggleQRScanner()" [disabled]="!selectedGroup">
            <i class="bi bi-qr-code-scan"></i>
            {{ isQRScannerActive ? 'QR Tarayıcıyı Kapat' : 'QR Kod Taray' }}
          </button>
        </div>

        <div class="control-item">
          <button class="btn btn-success" (click)="saveAttendance()" [disabled]="!hasChanges || isLoading">
            <i class="bi bi-check-circle"></i>
            {{ isLoading ? 'Kaydediliyor...' : 'Yoklamayı Kaydet' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Scanner -->
  <div class="qr-scanner-card" *ngIf="isQRScannerActive">
    <div class="card-header">
      <h3><i class="bi bi-camera"></i> QR Kod Tarayıcı</h3>
    </div>
    <div class="card-body">
      <div class="scanner-container">
        <video #videoElement class="scanner-video" autoplay playsinline></video>
        <canvas #canvasElement class="scanner-canvas" style="display: none;"></canvas>
        <div class="scanner-overlay">
          <div class="scanner-box"></div>
          <p>QR kodu kamera görüş alanına getirin</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Student List -->
  <div class="students-card" *ngIf="groupStudents.length > 0">
    <div class="card-header">
      <h3><i class="bi bi-people"></i> Öğrenci Listesi ({{ selectedGroup }})</h3>
      <div class="bulk-actions">
        <button class="btn btn-sm btn-outline-success" (click)="markAllPresent()">
          <i class="bi bi-check-all"></i> Hepsini Katıldı
        </button>
        <button class="btn btn-sm btn-outline-danger" (click)="markAllAbsent()">
          <i class="bi bi-x-octagon"></i> Hepsini Katılmadı
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="students-grid">
        <div class="student-card" *ngFor="let student of groupStudents">
          <div class="student-info">
            <div class="student-avatar">
              <img [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
                   [alt]="student.adi_soyadi" 
                   onerror="this.src='{{ getDefaultAvatar(student.adi_soyadi) }}'">
            </div>
            <div class="student-details">
              <h4>{{ student.adi_soyadi }}</h4>
              <p>{{ student.email }}</p>
              <span class="status-badge" 
                    [class]="getAttendanceStatus(student.id)">
                {{ getAttendanceStatusText(student.id) }}
              </span>
            </div>
          </div>

          <div class="attendance-actions">
            <button class="btn-action present" 
                    [class.active]="getAttendanceStatus(student.id) === 'present'"
                    (click)="markAttendance(student.id, 'present')">
              <i class="bi bi-check-lg"></i>
              <span>Katıldı</span>
            </button>
            <button class="btn-action absent" 
                    [class.active]="getAttendanceStatus(student.id) === 'absent'"
                    (click)="markAttendance(student.id, 'absent')">
              <i class="bi bi-x-lg"></i>
              <span>Katılmadı</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historical Data Filters -->
  <div class="filters-card" *ngIf="selectedGroup">
    <div class="card-header">
      <h3><i class="bi bi-filter"></i> Geçmiş Kayıtlar</h3>
    </div>
    <div class="card-body">
      <div class="filters-grid">
        <div class="date-range">
          <div class="date-input">
            <label>Başlangıç Tarihi</label>
            <input type="date" class="modern-input" [(ngModel)]="startDate">
          </div>
          <div class="date-input">
            <label>Bitiş Tarihi</label>
            <input type="date" class="modern-input" [(ngModel)]="endDate">
          </div>
        </div>

        <div class="quick-filters">
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeLastWeek()">
            <i class="bi bi-calendar-week"></i> Bu Hafta
          </button>
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeThisMonth()">
            <i class="bi bi-calendar3"></i> Bu Ay
          </button>
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeThisYear()">
            <i class="bi bi-calendar-range"></i> Bu Yıl
          </button>
        </div>

        <div class="filter-actions">
          <button class="btn btn-primary" (click)="loadHistoricalAttendanceByDateRange()" 
                  [disabled]="!startDate || !endDate">
            <i class="bi bi-search"></i> Filtrele
          </button>
          <button class="btn btn-secondary" (click)="loadAllAttendanceRecords()" 
                  [disabled]="!selectedGroup">
            <i class="bi bi-collection"></i> Tümünü Getir
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="stats-section" *ngIf="groupedAttendanceByDate.length > 0">
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon lessons">
          <i class="bi bi-calendar-event"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ groupedAttendanceByDate.length }}</div>
          <div class="stat-label">Toplam Ders</div>
          <div class="stat-description">Seçilen dönemdeki ders sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon attendance">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalPresentInPeriod() }}</div>
          <div class="stat-label">Toplam Katılım</div>
          <div class="stat-description">Derse katılan öğrenci sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon absence">
          <i class="bi bi-x-circle-fill"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalAbsentInPeriod() }}</div>
          <div class="stat-label">Toplam Devamsızlık</div>
          <div class="stat-description">Derse katılmayan öğrenci sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon percentage">
          <i class="bi bi-percent"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getAttendancePercentage() }}%</div>
          <div class="stat-label">Katılım Oranı</div>
          <div class="stat-description">Genel katılım yüzdesi</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historical Records -->
  <div class="historical-records" *ngIf="groupedAttendanceByDate.length > 0">
    <div class="records-header">
      <h3><i class="bi bi-clock-history"></i> Geçmiş Kayıtlar</h3>
    </div>

    <div class="timeline">
      <div class="timeline-item" *ngFor="let dateGroup of groupedAttendanceByDate">
        <div class="timeline-date">
          <div class="date-badge">
            <div class="day">{{ formatDate(dateGroup.tarih) }}</div>
            <div class="weekday">{{ getDayName(dateGroup.tarih) }}</div>
          </div>
        </div>

        <div class="timeline-content">
          <div class="attendance-summary">
            <div class="summary-stats">
              <span class="present-count">
                <i class="bi bi-check-circle"></i>
                {{ dateGroup.katilan_sayisi }} Katıldı
              </span>
              <span class="absent-count">
                <i class="bi bi-x-circle"></i>
                {{ dateGroup.katilmayan_sayisi }} Katılmadı
              </span>
            </div>

            <div class="students-list">
              <div class="present-students" *ngIf="dateGroup.katilanlar?.length > 0">
                <h5>Katılanlar:</h5>
                <div class="student-tags">
                  <span class="student-tag present" *ngFor="let student of dateGroup.katilanlar">
                    {{ student.adi_soyadi }}
                  </span>
                </div>
              </div>

              <div class="absent-students" *ngIf="dateGroup.katilmayanlar?.length > 0">
                <h5>Katılmayanlar:</h5>
                <div class="student-tags">
                  <span class="student-tag absent" *ngFor="let student of dateGroup.katilmayanlar">
                    {{ student.adi_soyadi }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Student Statistics -->
  <div class="student-stats-card" *ngIf="getStudentAttendanceStats().length > 0">
    <div class="card-header">
      <h3><i class="bi bi-graph-up"></i> Öğrenci İstatistikleri</h3>
    </div>
    <div class="card-body">
      <div class="student-stats-grid">
        <div class="student-stat-item" *ngFor="let studentStat of getStudentAttendanceStats()">
          <div class="student-info">
            <img [src]="studentStat.avatar || getDefaultAvatar(studentStat.name)" 
                 [alt]="studentStat.name" class="student-avatar">
            <div class="student-details">
              <h4>{{ studentStat.name }}</h4>
              <p>{{ studentStat.email }}</p>
            </div>
          </div>

          <div class="attendance-metrics">
            <div class="metric">
              <span class="metric-value">{{ studentStat.presentCount }}</span>
              <span class="metric-label">Katıldı</span>
            </div>
            <div class="metric">
              <span class="metric-value">{{ studentStat.absentCount }}</span>
              <span class="metric-label">Katılmadı</span>
            </div>
            <div class="metric">
              <span class="metric-value">{{ studentStat.attendancePercentage }}%</span>
              <span class="metric-label">Oran</span>
            </div>
          </div>

          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="studentStat.attendancePercentage"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!selectedGroup">
    <div class="empty-icon">
      <i class="bi bi-calendar-x"></i>
    </div>
    <h3>Grup Seçiniz</h3>
    <p>Devamsızlık takibi yapabilmek için önce bir grup seçmeniz gerekiyor.</p>
  </div>

  <div class="empty-state" *ngIf="selectedGroup && groupStudents.length === 0">
    <div class="empty-icon">
      <i class="bi bi-people"></i>
    </div>
    <h3>Öğrenci Bulunamadı</h3>
    <p>Seçilen grupta henüz öğrenci bulunmuyor.</p>
  </div>
</div>