<div class="modern-attendance-container">
  <!-- Controls Section -->
  <div class="controls-card">
    <div class="card-header">
      <h3><i class="bi bi-gear"></i> Kontroller</h3>
    </div>
    <div class="card-body">
      <div class="controls-grid">
        <div class="control-item">
          <label>Grup Seçin</label>
          <select class="modern-select" [(ngModel)]="selectedGroup" (change)="onGroupChange()">
            <option value="">Grup seçiniz...</option>
            <option *ngFor="let group of groups" [value]="group.name">{{ group.name }}</option>
          </select>
        </div>

        <div class="control-item">
          <label>Tarih</label>
          <input type="date" class="modern-input" [(ngModel)]="selectedDate" (change)="onDateChange()">
        </div>

        <div class="control-item">
          <button class="btn btn-primary" (click)="toggleQRScanner()" [disabled]="!selectedGroup">
            <i class="bi bi-qr-code-scan"></i>
            {{ isQRScannerActive ? 'QR Tarayıcıyı Kapat' : 'QR Kod Taray' }}
          </button>
        </div>

        <div class="control-item">
          <button class="btn btn-success" (click)="saveAttendance()" [disabled]="!hasChanges || isLoading">
            <i class="bi bi-check-circle"></i>
            {{ isLoading ? 'Kaydediliyor...' : 'Yoklamayı Kaydet' }}
          </button>
        </div>

        <div class="control-item">
          <button type="button" class="btn btn-warning" (click)="navigateToEkDers()" [disabled]="!selectedGroup">
            <i class="bi bi-plus-circle"></i>
            Ek Ders Yoklaması
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- QR Scanner -->
  <div class="qr-scanner-card" *ngIf="isQRScannerActive">
    <div class="card-header">
      <h3><i class="bi bi-camera"></i> QR Kod Tarayıcı</h3>
    </div>
    <div class="card-body">
      <div class="scanner-container">
        <video #videoElement class="scanner-video" autoplay playsinline></video>
        <canvas #canvasElement class="scanner-canvas" style="display: none;"></canvas>
        <div class="scanner-overlay">
          <div class="scanner-box"></div>
          <p>QR kodu kamera görüş alanına getirin</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Student List -->
  <div class="students-card" *ngIf="groupStudents.length > 0">
    <div class="card-header">
      <h3><i class="bi bi-people"></i> Öğrenci Listesi ({{ selectedGroup }})</h3>
      <div class="bulk-actions">
        <button class="btn btn-sm btn-outline-success" (click)="markAllPresent()">
          <i class="bi bi-check-all"></i> Hepsini Katıldı
        </button>
        <button class="btn btn-sm btn-outline-danger" (click)="markAllAbsent()">
          <i class="bi bi-x-octagon"></i> Hepsini Katılmadı
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="students-grid">
        <div class="student-card" *ngFor="let student of groupStudents">
          <div class="student-info">
            <div class="student-avatar">
              <img [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
                   [alt]="student.adi_soyadi" >
            </div>
            <div class="student-details">
              <h4>{{ student.adi_soyadi }}</h4>
              <p>{{ student.email }}</p>
              <span class="status-badge" 
                    [class]="getAttendanceStatus(student.id)">
                {{ getAttendanceStatusText(student.id) }}
              </span>
            </div>
          </div>

          <div class="attendance-actions">
            <button class="btn-action present" 
                    [class.active]="getAttendanceStatus(student.id) === 'present'"
                    (click)="markAttendance(student.id, 'present')">
              <i class="bi bi-check-lg"></i>
              <span>Katıldı</span>
            </button>
            <button class="btn-action absent" 
                    [class.active]="getAttendanceStatus(student.id) === 'absent'"
                    (click)="markAttendance(student.id, 'absent')">
              <i class="bi bi-x-lg"></i>
              <span>Katılmadı</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historical Data Filters -->
  <div class="filters-card" *ngIf="selectedGroup">
    <div class="card-header">
      <h3><i class="bi bi-filter"></i> Geçmiş Kayıtlar</h3>
    </div>
    <div class="card-body">
      <div class="filters-grid">
        <div class="date-range">
          <div class="date-input">
            <label>Başlangıç Tarihi</label>
            <input type="date" class="modern-input" [(ngModel)]="startDate">
          </div>
          <div class="date-input">
            <label>Bitiş Tarihi</label>
            <input type="date" class="modern-input" [(ngModel)]="endDate">
          </div>
        </div>

        <div class="quick-filters">
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeLastWeek()">
            <i class="bi bi-calendar-week"></i> Bu Hafta
          </button>
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeThisMonth()">
            <i class="bi bi-calendar3"></i> Bu Ay
          </button>
          <button class="btn btn-outline-primary btn-sm" (click)="setDateRangeThisYear()">
            <i class="bi bi-calendar-range"></i> Bu Yıl
          </button>
        </div>

        <div class="filter-actions">
          <button class="btn btn-primary" (click)="loadHistoricalAttendanceByDateRange()" 
                  [disabled]="!startDate || !endDate">
            <i class="bi bi-search"></i> Filtrele
          </button>
          <button class="btn btn-secondary" (click)="loadAllAttendanceRecords()" 
                  [disabled]="!selectedGroup">
            <i class="bi bi-collection"></i> Tümünü Getir
          </button>
          <button class="btn btn-warning" (click)="debugStudentRecords()" 
                  [disabled]="!selectedGroup || groupStudents.length === 0">
            <i class="bi bi-bug"></i> Debug Kayıtları
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Section -->
  <div class="stats-section" *ngIf="groupedAttendanceByDate.length > 0">
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-icon lessons">
          <i class="bi bi-calendar-event"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ groupedAttendanceByDate.length }}</div>
          <div class="stat-label">Toplam Ders</div>
          <div class="stat-description">Seçilen dönemdeki ders sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon attendance">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalPresentInPeriod() }}</div>
          <div class="stat-label">Toplam Katılım</div>
          <div class="stat-description">Derse katılan öğrenci sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon absence">
          <i class="bi bi-x-circle-fill"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getTotalAbsentInPeriod() }}</div>
          <div class="stat-label">Toplam Devamsızlık</div>
          <div class="stat-description">Derse katılmayan öğrenci sayısı</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon percentage">
          <i class="bi bi-percent"></i>
        </div>
        <div class="stat-content">
          <div class="stat-number">{{ getAttendancePercentage() }}%</div>
          <div class="stat-label">Katılım Oranı</div>
          <div class="stat-description">Genel katılım yüzdesi</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Historical Records -->
  <div class="historical-records" *ngIf="groupedAttendanceByDate.length > 0">
    <div class="records-header">
      <h3><i class="bi bi-clock-history"></i> Geçmiş Kayıtlar</h3>
    </div>

    <div class="timeline">
      <div class="timeline-item" *ngFor="let dateGroup of groupedAttendanceByDate">
        <div class="timeline-date">
          <div class="date-badge">
            <div class="day">{{ formatDate(dateGroup.tarih) }}</div>
            <div class="weekday">{{ getDayName(dateGroup.tarih) }}</div>
          </div>
        </div>

        <div class="timeline-content">
          <div class="attendance-summary">
            <div class="summary-stats">
              <span class="present-count">
                <i class="bi bi-check-circle"></i>
                {{ dateGroup.katilan_sayisi }} Katıldı
              </span>
              <span class="absent-count">
                <i class="bi bi-x-circle"></i>
                {{ dateGroup.katilmayan_sayisi }} Katılmadı
              </span>
            </div>

            <div class="students-list">
              <div class="present-students" *ngIf="dateGroup.katilanlar?.length > 0">
                <h5><i class="bi bi-person-check"></i> Derse Katılanlar ({{ dateGroup.katilanlar?.length }}):</h5>
                <div class="student-tags">
                  <span class="student-tag present" *ngFor="let student of dateGroup.katilanlar">
                    <i class="bi bi-check-circle"></i>
                    {{ student.adi_soyadi }}
                  </span>
                </div>
              </div>

              <div class="absent-students" *ngIf="dateGroup.katilmayanlar?.length > 0">
                <h5><i class="bi bi-person-x"></i> Derse Katılmayanlar ({{ dateGroup.katilmayanlar?.length }}):</h5>
                <div class="student-tags">
                  <span class="student-tag absent" *ngFor="let student of dateGroup.katilmayanlar">
                    <i class="bi bi-x-circle"></i>
                    {{ student.adi_soyadi || student.name }}
                  </span>
                </div>
              </div>

              <!-- Katılmayan yoksa bilgi mesajı göster -->
              <div class="no-absents" *ngIf="dateGroup.katilmayan_sayisi === 0">
                <p class="text-success">
                  <i class="bi bi-check-circle-fill"></i> 
                  Bu derste hiçbir öğrenci devamsızlık yapmadı!
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Öğrenci Bilgi Kartları -->
    <div class="ogrenci-bilgi-kartlari" *ngIf="selectedGroup && !viewHistoricalData">
      <h3 class="section-title">
        <i class="bi bi-people-fill"></i>
        Öğrenci Bilgi Kartları
      </h3>
      <div class="bilgi-kartlari-grid">
        <div class="ogrenci-bilgi-karti" *ngFor="let stats of getStudentAttendanceStats()">
          <div class="kart-header">
            <img [src]="stats.avatar || getDefaultAvatar(stats.name)" 
                 class="ogrenci-avatar" 
                 alt="Avatar">
            <div class="ogrenci-bilgileri">
              <h5 class="ogrenci-adi">{{ stats.name }}</h5>
              <p class="ogrenci-email">{{ stats.email }}</p>
              <div class="katilim-badge" [class.yuksek]="stats.attendancePercentage >= 80" 
                   [class.orta]="stats.attendancePercentage >= 60 && stats.attendancePercentage < 80"
                   [class.dusuk]="stats.attendancePercentage < 60">
                %{{ stats.attendancePercentage }} Katılım
              </div>
            </div>
          </div>

          <div class="kart-istatistikler">
            <div class="istatistik-satiri">
              <div class="istatistik-kutusu katildi">
                <div class="istatistik-sayi">{{ stats.presentCount }}</div>
                <div class="istatistik-etiket">Katıldı</div>
              </div>
              <div class="istatistik-kutusu katilmadi">
                <div class="istatistik-sayi">{{ stats.absentCount }}</div>
                <div class="istatistik-etiket">Katılmadı</div>
              </div>
            </div>

            <div class="odeme-bilgileri">
              <div class="odeme-satiri">
                <span class="odeme-etiket">Beklenen Ödeme:</span>
                <span class="odeme-tutar">{{ formatCurrency(stats.expectedTotalAmount) }}</span>
              </div>
              <div class="sonraki-odeme" *ngIf="stats.lessonsUntilNextPayment > 0">
                <i class="bi bi-clock"></i>
                Sonraki ödemeye {{ stats.lessonsUntilNextPayment }} ders kaldı
              </div>
              <div class="odeme-zamani" *ngIf="stats.lessonsUntilNextPayment === 0">
                <i class="bi bi-exclamation-circle"></i>
                Ödeme Zamanı!
              </div>
            </div>
          </div>

          <div class="kart-footer">
            <button type="button" 
                    class="detay-buton" 
                    (click)="loadStudentDetailedStats(stats.id)"
                    [disabled]="isLoading">
              <i class="bi bi-info-circle-fill"></i>
              <span *ngIf="!isLoading">Detaylı İstatistikleri Gör</span>
              <span *ngIf="isLoading">Yükleniyor...</span>
            </button>
          </div>
        </div>
      </div>
    </div>

  <!-- Empty State -->
  <div class="empty-state" *ngIf="!selectedGroup">
    <div class="empty-icon">
      <i class="bi bi-calendar-x"></i>
    </div>
    <h3>Grup Seçiniz</h3>
    <p>Devamsızlık takibi yapabilmek için önce bir grup seçmeniz gerekiyor.</p>
  </div>

  <div class="empty-state" *ngIf="selectedGroup && groupStudents.length === 0">
    <div class="empty-icon">
      <i class="bi bi-people"></i>
    </div>
    <h3>Öğrenci Bulunamadı</h3>
    <p>Seçilen grupta henüz öğrenci bulunmuyor.</p>
  </div>
</div>

<!-- Öğrenci Devamsızlık Analiz Tablosu -->
<div class="student-analysis-section" *ngIf="selectedGroup && historicalAttendance.length > 0">
  <div class="section-header">
    <h3><i class="bi bi-graph-up"></i> Öğrenci Devamsızlık Analizi</h3>
    <p class="section-description">Öğrencilerin katılım durumları ve ders tiplerine göre detaylı analiz</p>
  </div>

  <div class="analysis-table-container">
    <table class="analysis-table">
      <thead>
        <tr>
          <th>Öğrenci</th>
          <th>Toplam Kayıt</th>
          <th colspan="3">Katıldı (Present)</th>
          <th colspan="3">Katılmadı (Absent)</th>
          <th>Katılım %</th>
        </tr>
        <tr class="sub-header">
          <th></th>
          <th></th>
          <th>Toplam</th>
          <th>Normal Ders</th>
          <th>Ek Ders</th>
          <th>Toplam</th>
          <th>Normal Ders</th>
          <th>Ek Ders</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let analysis of getStudentAttendanceAnalysis()" class="student-row">
          <td class="student-info">
            <img [src]="analysis.avatar || getDefaultAvatar(analysis.name)" 
                 class="student-avatar-small" 
                 alt="Avatar">
            <div class="student-details">
              <span class="student-name">{{ analysis.name }}</span>
              <span class="student-email">{{ analysis.email }}</span>
            </div>
          </td>
          <td class="total-records">{{ analysis.totalRecords }}</td>
          <td class="present-total">{{ analysis.present.total }}</td>
          <td class="present-normal">{{ analysis.present.normal }}</td>
          <td class="present-ek">{{ analysis.present.ek_ders }}</td>
          <td class="absent-total">{{ analysis.absent.total }}</td>
          <td class="absent-normal">{{ analysis.absent.normal }}</td>
          <td class="absent-ek">{{ analysis.absent.ek_ders }}</td>
          <td class="attendance-percentage">
            <div class="percentage-badge" [class.high]="analysis.attendancePercentage >= 80" 
                 [class.medium]="analysis.attendancePercentage >= 60 && analysis.attendancePercentage < 80"
                 [class.low]="analysis.attendancePercentage < 60">
              {{ analysis.attendancePercentage }}%
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Student Detail Modal -->
<div class="modern-modal-overlay" *ngIf="showStudentStatsModal" (click)="closeStudentStatsModal()">
  <div class="modern-modal-content large-modal" (click)="$event.stopPropagation()">
    <div class="modern-modal-header">
      <div class="modal-title-section">
        <div class="modal-icon">
          <i class="bi bi-graph-up"></i>
        </div>
        <div class="modal-title-text">
          <h4>Öğrenci Detay İstatistikleri</h4>
          <p *ngIf="selectedStudentStats">{{ selectedStudentStats.student_info.name }}</p>
        </div>
      </div>
      <button type="button" class="modern-close-btn" (click)="closeStudentStatsModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>

    <div class="modern-modal-body" *ngIf="selectedStudentStats">
      <!-- Öğrenci Temel Bilgileri -->
      <div class="student-basic-info mb-4">
        <div class="row">
          <div class="col-md-6">
            <div class="info-card">
              <h6><i class="bi bi-person-fill me-2"></i>Öğrenci Bilgileri</h6>
              <div class="info-item">
                <span class="label">Ad Soyad:</span>
                <span class="value">{{ selectedStudentStats.student_info.name }}</span>
              </div>
              <div class="info-item">
                <span class="label">E-posta:</span>
                <span class="value">{{ selectedStudentStats.student_info.email }}</span>
              </div>
              <div class="info-item">
                <span class="label">Grup:</span>
                <span class="value">{{ selectedStudentStats.student_info.grup }}</span>
              </div>
              <div class="info-item">
                <span class="label">Ders Ücreti:</span>
                <span class="value">{{ formatCurrency(selectedStudentStats.student_info.ucret) }}</span>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="info-card">
              <h6><i class="bi bi-graph-up me-2"></i>Katılım İstatistikleri</h6>
              <div class="info-item">
                <span class="label">Toplam Ders:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.total_lessons }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katıldığı Ders:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.present_count }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katılmadığı Ders:</span>
                <span class="value">{{ selectedStudentStats.attendance_stats.absent_count }}</span>
              </div>
              <div class="info-item">
                <span class="label">Katılım Oranı:</span>
                <span class="value badge bg-success">%{{ selectedStudentStats.attendance_stats.attendance_percentage }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Ödeme İstatistikleri -->
      <div class="payment-stats mb-4">
        <div class="info-card">
          <h6><i class="bi bi-credit-card me-2"></i>Ödeme İstatistikleri</h6>
          <div class="row">
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ selectedStudentStats.payment_stats.expected_payment_cycles }}</div>
                <div class="stat-label">Beklenen Dönem</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ formatCurrency(selectedStudentStats.payment_stats.expected_total_amount) }}</div>
                <div class="stat-label">Beklenen Tutar</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value">{{ formatCurrency(selectedStudentStats.payment_stats.total_paid) }}</div>
                <div class="stat-label">Ödenen Tutar</div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="stat-item">
                <div class="stat-value" [class.text-danger]="selectedStudentStats.payment_stats.debt > 0">
                  {{ formatCurrency(selectedStudentStats.payment_stats.debt) }}
                </div>
                <div class="stat-label">Borç</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Son Katılım Kayıtları -->
      <div class="recent-attendance">
        <div class="info-card">
          <h6><i class="bi bi-clock-history me-2"></i>Son Katılım Kayıtları</h6>
          <div class="attendance-timeline">
            <div class="timeline-item" *ngFor="let record of selectedStudentStats.recent_attendance">
              <div class="timeline-marker" [class.present]="record.durum === 'present'" [class.absent]="record.durum === 'absent'">
                <i class="bi" [class.bi-check-circle]="record.durum === 'present'" [class.bi-x-circle]="record.durum === 'absent'"></i>
              </div>
              <div class="timeline-content">
                <div class="timeline-date">{{ formatDate(record.tarih) }}</div>
                <div class="timeline-status" [class.text-success]="record.durum === 'present'" [class.text-danger]="record.durum === 'absent'">
                  {{ record.durum === 'present' ? 'Katıldı' : 'Katılmadı' }}
                </div>
                <div class="timeline-time text-muted small">{{ record.zaman | date:'HH:mm' }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modern-modal-footer">
      <button type="button" class="modern-btn modern-btn-secondary" (click)="closeStudentStatsModal()">
        <i class="bi bi-x-circle"></i>
        Kapat
      </button>
    </div>
  </div>
</div>
<!-- Görünüm Toggle Buttons -->
    <div class="view-toggle-buttons">
      <button
        class="btn btn-outline-info me-2"
        (click)="toggleHistoricalView()"
        [class.active]="viewHistoricalData"
      >
        <i class="fas fa-history"></i>
        {{ viewHistoricalData ? 'Geçmiş Kayıtları Gizle' : 'Geçmiş Kayıtları Göster' }}
      </button>

      <button
        class="btn btn-outline-success"
        (click)="toggleProcessedLessonsView()"
        [class.active]="viewProcessedLessons"
      >
        <i class="fas fa-chalkboard-teacher"></i>
        {{ viewProcessedLessons ? 'İşlenen Dersleri Gizle' : 'İşlenen Dersleri Göster' }}
      </button>
    </div>
<!-- İşlenen Dersler Bölümü -->
    <div class="processed-lessons-section" *ngIf="viewProcessedLessons">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-chalkboard-teacher"></i>
            İşlenen Dersler (Normal Dersler)
          </h5>
        </div>
        <div class="card-body">
          <!-- Tarih Filtre Butonları -->
          <div class="date-filter-buttons mb-3">
            <div class="row">
              <div class="col-md-6">
                <div class="quick-filters">
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="setProcessedLessonsDateRangeLastWeek()">
                    Son 7 Gün
                  </button>
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="setProcessedLessonsDateRangeLastMonth()">
                    Son 30 Gün
                  </button>
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="setProcessedLessonsDateRangeThisMonth()">
                    Bu Ay
                  </button>
                  <button class="btn btn-sm btn-outline-primary me-2" (click)="setProcessedLessonsDateRangeThisYear()">
                    Bu Yıl
                  </button>
                  <button class="btn btn-sm btn-outline-secondary" (click)="loadAllProcessedLessons()">
                    Tüm Kayıtlar
                  </button>
                </div>
              </div>
              <div class="col-md-6">
                <div class="custom-date-range">
                  <div class="input-group">
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      [(ngModel)]="startDate"
                      placeholder="Başlangıç Tarihi"
                    />
                    <input
                      type="date"
                      class="form-control form-control-sm"
                      [(ngModel)]="endDate"
                      placeholder="Bitiş Tarihi"
                    />
                    <button
                      class="btn btn-sm btn-primary"
                      (click)="loadProcessedLessonsByDateRange()"
                      [disabled]="!startDate || !endDate"
                    >
                      Filtrele
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- İşlenen Dersler Listesi -->
          <div class="processed-lessons-list" *ngIf="processedLessonsGroupedByDate.length > 0; else noProcessedLessons">
            <div class="lesson-date-group" *ngFor="let dateGroup of processedLessonsGroupedByDate">
              <div class="date-header">
                <h6 class="mb-2">
                  <i class="fas fa-calendar-day"></i>
                  {{ formatDate(dateGroup.tarih) }} - {{ getDayName(dateGroup.tarih) }}
                  <span class="badge bg-success ms-2">{{ dateGroup.katilan_sayisi }} Katıldı</span>
                  <span class="badge bg-danger ms-1">{{ dateGroup.katilmayan_sayisi }} Katılmadı</span>
                </h6>
              </div>

              <div class="row">
                <!-- Katılan Öğrenciler -->
                <div class="col-md-6">
                  <div class="attendance-group present-group">
                    <h6 class="text-success">
                      <i class="fas fa-check-circle"></i>
                      Derse Katılan Öğrenciler ({{ dateGroup.katilanlar?.length || 0 }})
                    </h6>
                    <div class="student-list present-students" *ngIf="dateGroup.katilanlar && dateGroup.katilanlar.length > 0; else noPresent">
                      <div class="student-item" *ngFor="let student of dateGroup.katilanlar">
                        <div class="student-avatar">
                          <img 
                            [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
                            [alt]="student.adi_soyadi"
                            class="rounded-circle"
                            width="30" 
                            height="30"
                          />
                        </div>
                        <div class="student-info">
                          <div class="student-name">{{ student.adi_soyadi }}</div>
                          <div class="student-email text-muted small">{{ student.email }}</div>
                        </div>
                        <div class="attendance-badge">
                          <span class="badge bg-success">
                            <i class="fas fa-check"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                    <ng-template #noPresent>
                      <div class="text-muted">Bu derste katılan öğrenci yok</div>
                    </ng-template>
                  </div>
                </div>

                <!-- Katılmayan Öğrenciler -->
                <div class="col-md-6">
                  <div class="attendance-group absent-group">
                    <h6 class="text-danger">
                      <i class="fas fa-times-circle"></i>
                      Derse Katılmayan Öğrenciler ({{ dateGroup.katilmayanlar?.length || 0 }})
                    </h6>
                    <div class="student-list absent-students" *ngIf="dateGroup.katilmayanlar && dateGroup.katilmayanlar.length > 0; else noAbsent">
                      <div class="student-item" *ngFor="let student of dateGroup.katilmayanlar">
                        <div class="student-avatar">
                          <img 
                            [src]="student.avatar || getDefaultAvatar(student.adi_soyadi)" 
                            [alt]="student.adi_soyadi"
                            class="rounded-circle"
                            width="30" 
                            height="30"
                          />
                        </div>
                        <div class="student-info">
                          <div class="student-name">{{ student.adi_soyadi }}</div>
                          <div class="student-email text-muted small">{{ student.email }}</div>
                        </div>
                        <div class="attendance-badge">
                          <span class="badge bg-danger">
                            <i class="fas fa-times"></i>
                          </span>
                        </div>
                      </div>
                    </div>
                    <ng-template #noAbsent>
                      <div class="text-muted">Bu derste katılmayan öğrenci yok</div>
                    </ng-template>
                  </div>
                </div>
              </div>

              <hr />
            </div>
          </div>

          <ng-template #noProcessedLessons>
            <div class="no-data text-center py-4">
              <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">İşlenen Ders Bulunamadı</h5>
              <p class="text-muted">
                {{ selectedGroup ? 'Seçilen grup için işlenen normal ders kaydı bulunamadı.' : 'Önce bir grup seçiniz.' }}
              </p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Geçmiş Devamsızlık Kayıtları -->
    <div class="historical-attendance" *ngIf="viewHistoricalData">
<!-- İşlenen Dersler Bölümü - Modern Tasarım -->
    <div class="modern-lessons-section">
      <div class="modern-section-header">
        <div class="header-content">
          <div class="header-title">
            <i class="bi bi-book-half text-primary"></i>
            <h3>İşlenen Dersler</h3>
            <span class="badge bg-light text-primary">Normal Dersler</span>
          </div>
          <div class="lessons-count" *ngIf="processedLessons.length > 0">
            <span class="count-badge">{{ processedLessons.length }}</span>
            <span class="count-text">Ders</span>
          </div>
        </div>
      </div>

      <div class="modern-lessons-grid" *ngIf="processedLessons.length > 0">
        <div class="modern-lesson-card" *ngFor="let lesson of processedLessons; let i = index">
          <div class="lesson-card-header">
            <div class="lesson-number-badge">
              <span class="lesson-number">{{ i + 1 }}</span>
            </div>
            <div class="lesson-date-info">
              <div class="lesson-date">
                <i class="bi bi-calendar3"></i>
                {{ formatDate(lesson.tarih) }}
              </div>
              <div class="lesson-time">
                <i class="bi bi-clock"></i>
                {{ getTimeFromDate(lesson.tarih) }}
              </div>
            </div>
          </div>

          <div class="lesson-card-body">
            <div class="lesson-details">
              <div class="lesson-topic" *ngIf="lesson.konu">
                <i class="bi bi-lightbulb text-warning"></i>
                <span>{{ lesson.konu }}</span>
              </div>
              <div class="lesson-description" *ngIf="lesson.aciklama">
                <i class="bi bi-card-text text-info"></i>
                <span>{{ lesson.aciklama }}</span>
              </div>
              <div class="lesson-method">
                <i class="bi bi-person-check text-success"></i>
                <span>{{ lesson.yontem === 'qr' ? 'QR Kod' : 'Manuel' }}</span>
              </div>
            </div>
          </div>

          <div class="lesson-card-footer">
            <div class="student-stats">
              <div class="stat-item present">
                <i class="bi bi-check-circle-fill"></i>
                <span>{{ getAttendanceCountByLesson(lesson, 'present') }} Katıldı</span>
              </div>
              <div class="stat-item absent">
                <i class="bi bi-x-circle-fill"></i>
                <span>{{ getAttendanceCountByLesson(lesson, 'absent') }} Katılmadı</span>
              </div>
            </div>

            <button class="detail-btn" (click)="toggleLessonDetails(i)">
              <i class="bi" [class.bi-chevron-down]="!lesson.showDetails" [class.bi-chevron-up]="lesson.showDetails"></i>
              Detay
            </button>
          </div>

          <div class="lesson-students-detail" *ngIf="lesson.showDetails">
            <div class="students-header">
              <h6><i class="bi bi-people"></i> Öğrenci Detayları</h6>
            </div>
            <div class="students-grid">
              <div class="student-item" *ngFor="let student of getStudentsByLesson(lesson)" 
                   [class.present]="student.durum === 'present'" 
                   [class.absent]="student.durum === 'absent'">
                <div class="student-avatar">
                  <i class="bi bi-person-circle"></i>
                </div>
                <div class="student-info">
                  <span class="student-name">{{ student.adi_soyadi }}</span>
                  <span class="student-status">
                    <i class="bi" [class.bi-check-circle]="student.durum === 'present'" 
                       [class.bi-x-circle]="student.durum === 'absent'"></i>
                    {{ student.durum === 'present' ? 'Katıldı' : 'Katılmadı' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <span class="lesson-index">{{ i + 1 }}</span>
                    <div class="lesson-content">
                      <div class="lesson-main-info">
                        <h4 class="lesson-title">{{ lesson.konu_adi }}</h4>
                        <p class="lesson-description">{{ lesson.aciklama || 'Açıklama yok' }}</p>
                      </div>

                      <div class="lesson-details">
                        <div class="lesson-detail">
                          <i class="fas fa-calendar-alt"></i>
                          <span>{{ formatDate(lesson.tarih) }}</span>
                        </div>
                        <div class="lesson-detail">
                          <i class="fas fa-clock"></i>
                          <span>{{ getTimeFromDate(lesson.tarih) }}</span>
                        </div>
                        <div class="lesson-detail">
                          <i class="fas fa-users"></i>
                          <span>{{ lesson.grup_adi }}</span>
                        </div>
                      </div>
                    </div>

                    <div class="lesson-actions">
                      <button class="detay-buton" type="button">
                        <i class="fas fa-eye"></i>
                        <span>Detayları Gör</span>
                      </button>
                    </div>
                  </div>

                <hr />
              </div>
            </div>
    </div>
  </div>
</div>